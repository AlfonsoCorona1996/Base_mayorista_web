@if (order(); as current) {
  <section class="page">
    <header class="page-head">
      <div class="page-head-main">
        <button class="link-back link-back--icon" type="button" (click)="backToList()" aria-label="Volver">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M15 18 9 12l6-6"></path>
          </svg>
        </button>
        <div class="order-id-wrap">
          <p class="eyebrow order-id-line">Pedido {{ current.order_id }}</p>
          <button
            type="button"
            class="order-id-copy"
            aria-label="Copiar ID del pedido"
            (click)="copyOrderId(current.order_id)"
          ></button>
          @if (copiedOrderId()) {
            <span class="copy-toast">Â¡Copiado!</span>
          }
        </div>
        <div class="title-row">
          <h1>{{ customerName(current) }}</h1>
          <span class="chip status-badge" [class]="statusClass(current.status)">{{ statusLabel(current.status) }}</span>
        </div>
        <p class="muted">{{ routeName(current) }}</p>
      </div>
      <div class="status-actions">
        @if (phaseAction(current); as phase) {
          <button
            type="button"
            class="btn confirm-intelligent-btn"
            [class.primary]="phase.actionId !== 'confirm_items' || isConfirmExistencesReady(current)"
            [class.ghost]="phase.actionId === 'confirm_items' && !isConfirmExistencesReady(current)"
            [disabled]="phase.actionId === 'confirm_items' && current.items.length === 0"
            (click)="openActionModal(current)"
          >
            {{ phase.actionId === "confirm_items" ? confirmExistencesActionLabel(current) : phase.label }}
          </button>
        }
      </div>
    </header>

    @if (requiresPlannedPackages(current)) {
      <div class="sticky-banner">
        <div>
          <p class="eyebrow">Define paquetes planificados</p>
          <p class="muted">Necesitamos la cantidad esperada para habilitar acciones de logÃ­stica.</p>
        </div>
        <button type="button" class="btn primary" (click)="openPlannedPackages()">Definir paquetes</button>
      </div>
    }

    <section class="summary" aria-label="Resumen del pedido">
      <div class="summary-card summary-card--status">
        <p class="eyebrow">Estado</p>
        <strong class="summary-value">{{ statusLabel(current.status) }}</strong>
      </div>
      <div class="summary-card">
        <p class="eyebrow">Actualizado</p>
        <strong class="summary-value">{{ current.updated_at | date: "short" }}</strong>
      </div>
      <div class="summary-card">
        <p class="eyebrow">Items</p>
        <strong class="summary-value">{{ current.items.length }}</strong>
      </div>
      <div class="summary-card">
        <p class="eyebrow">Paquetes</p>
        <strong class="summary-value">{{ current.packages.length }}</strong>
      </div>
      <div class="summary-card">
        <p class="eyebrow">Planificados</p>
        <strong class="summary-value">{{ plannedPackages(current) ?? "-" }}</strong>
      </div>
      <div class="summary-card summary-card--financial">
        <div>
          <p class="eyebrow">Total clienta</p>
          <strong class="summary-value">{{ formatCurrency(totals().totalClienta) }}</strong>
        </div>
        <div>
          <p class="eyebrow kpi-nowrap">Costo proveedor</p>
          <strong class="summary-value">{{ formatCurrency(totals().totalCost) }}</strong>
        </div>
        <div>
          <p class="eyebrow">Ganancia</p>
          <strong class="summary-value summary-value--profit profit-pill">{{ formatCurrency(totals().ganancia) }}</strong>
        </div>
      </div>
    </section>

    <nav class="section-nav" aria-label="NavegaciÃ³n de secciones">
      <button type="button" (click)="scrollToSection('incidencias')">Incidencias</button>
      <button type="button" (click)="scrollToSection('productos')">Productos</button>
      <button type="button" (click)="scrollToSection('paquetes')">Paquetes</button>
      <button type="button" (click)="scrollToSection('bitacora')">BitÃ¡cora</button>
    </nav>

    <section class="panel" id="incidencias" #incidentsSection>
      <div class="panel-head">
        <h2>Incidencias</h2>
        <div class="panel-actions">
          <button type="button" class="btn ghost with-icon" (click)="openIncidentModal()">
            <span class="btn-icon" aria-hidden="true">+</span>
            Nueva incidencia
          </button>
          <button type="button" class="btn link" (click)="toggleResolved()">
            {{ showResolvedIncidents() ? "Ocultar" : "Ver" }} resueltas ({{ resolvedIncidents().length }})
          </button>
        </div>
      </div>
      <div class="incidents">
        @if (openIncidents().length === 0) {
          <p class="muted">Sin incidencias abiertas.</p>
        }
        @for (inc of openIncidents(); track inc.id) {
          <article class="incident-card" [class.high]="inc.severity === 'high'">
            <div>
              <p class="eyebrow">{{ inc.title }} Â· {{ inc.type }} Â· {{ inc.severity }}</p>
              <p>{{ inc.reason }}</p>
              @if (inc.assigneeId) {
                <p class="muted">Asignado a {{ inc.assigneeId }}</p>
              }
              <p class="muted">Creada {{ inc.createdAt | date: "short" }} Â· {{ inc.createdBy }}</p>
              @if ((inc.evidenceUrls?.length || 0) > 0) {
                <div class="evidence">
                  @for (url of inc.evidenceUrls || []; track url) {
                    <a [href]="url" target="_blank" rel="noreferrer">Evidencia</a>
                  }
                </div>
              }
            </div>
            <div class="incident-actions">
              <button type="button" class="btn ghost" (click)="openResolveModal(inc)">Resolver</button>
              <button type="button" class="btn ghost" (click)="openAssignModal(inc)">Asignar</button>
              <label class="btn ghost file-btn">
                <input type="file" accept="image/*" (change)="attachEvidence(inc, $event)" />
                {{ uploadingEvidence()[inc.id] ? "Subiendo..." : "Adjuntar foto" }}
              </label>
              <button type="button" class="btn link" (click)="scrollToTimeline()">Ver en bitÃ¡cora</button>
            </div>
          </article>
        }
      </div>

      @if (showResolvedIncidents() && resolvedIncidents().length > 0) {
        <div class="incidents resolved">
          @for (inc of resolvedIncidents(); track inc.id) {
            <article class="incident-card resolved">
              <div>
                <p class="eyebrow">{{ inc.title }} Â· {{ inc.type }}</p>
                <p class="muted">Resuelta {{ inc.resolvedAt | date: "short" }} Â· {{ inc.resolvedBy }}</p>
                @if (inc.resolutionNote) {
                  <p class="muted">{{ inc.resolutionNote }}</p>
                }
              </div>
            </article>
          }
        </div>
      }
    </section>

    <section class="panel" id="productos">
      <div class="panel-head">
        <h2>Productos</h2>
        <div class="panel-actions">
          <button type="button" class="btn primary with-icon" (click)="openAddItemModal()" [disabled]="!canEditItems(current)">
            <span class="btn-icon" aria-hidden="true">+</span>
            Agregar producto
          </button>
          <p class="muted">Escanea o cambia el estado por producto.</p>
        </div>
      </div>
      @if (current.items.length > 0) {
        <div class="products-toolbar" role="tablist" aria-label="Filtro de productos por stock">
          <button
            type="button"
            class="products-filter-btn"
            [class.active]="productStockFilter() === 'all'"
            (click)="setProductStockFilter('all')"
          >
            Todos ({{ totalItems(current) }})
          </button>
          <button
            type="button"
            class="products-filter-btn"
            [class.active]="productStockFilter() === 'insufficient'"
            [class.products-filter-btn--magnet]="shouldMagnetizeInsufficientTab(current)"
            [disabled]="insufficientItemsCount(current) === 0"
            (click)="setProductStockFilter('insufficient')"
          >
            Faltantes
            <span class="products-filter-count" [class.products-filter-count--alert]="insufficientItemsCount(current) > 0">
              ({{ insufficientItemsCount(current) }})
            </span>
          </button>
          @if (isConfirmItemsPhase(current) && hasPendingItems(current)) {
            <button
              type="button"
              class="products-batch-btn"
              (click)="confirmarTodoDisponible()"
              [disabled]="!canMagicConfirm(current)"
            >
              Marcar todo como disponible
            </button>
          }
        </div>
      }
      <div class="items order-item-grid">
        @for (item of filteredProductItems(current); track item.item_id) {
          <article
            class="order-item-card card-product"
            [id]="productCardId(item)"
            [class.has-incident]="itemHasOpenIncident(item.item_id)"
            [class.order-item-card--insufficient]="hasInsufficientStock(item)"
            [class.order-item-card--confirmado]="isConfirmedConfirmation(item)"
            [class.order-item-card--sin-stock]="isOutOfStockConfirmation(item)"
            [class.card-product--confirmed]="isConfirmedConfirmation(item)"
            [class.card-product--out-of-stock]="isOutOfStockConfirmation(item)"
            [class.card-product--alert]="hasInsufficientStock(item) && !isOutOfStockConfirmation(item)"
          >
            <div class="product-media">
              <img [src]="itemImage(item) || 'https://via.placeholder.com/240x200?text=Prod'" [alt]="item.title" />
            </div>

            <div class="product-main">
              <div class="product-title-stack">
                <h4 class="product-name">{{ item.title }}</h4>
                <span
                  class="origin-badge origin-badge--top"
                  [class.origin-badge--almacen]="item.source === 'inventario'"
                  [class.origin-badge--catalogo]="item.source === 'catalogo'"
                >
                  @if (item.source === "inventario") {
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <path d="M3 7h18v13H3z"></path>
                      <path d="M3 7 12 3l9 4"></path>
                    </svg>
                    <span>ALMACÃ‰N</span>
                  } @else if (item.source === "catalogo") {
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <path d="M4 5a2 2 0 0 1 2-2h12v17H6a2 2 0 0 0-2 2z"></path>
                      <path d="M18 3a2 2 0 0 1 2 2v17"></path>
                    </svg>
                    <span>CATÃLOGO</span>
                  } @else {
                    <span aria-hidden="true">E</span>
                    <span>EXTERNO</span>
                  }
                </span>
              </div>
              <p class="meta product-meta">Talla: {{ item.variant || "Sin talla" }} | Color: {{ item.color || "Sin color" }}</p>

              <div class="chips product-chips">
                <span class="chip chip--pieces">Piezas: {{ item.quantity }}</span>
                @if (isOutOfStockConfirmation(item)) {
                  <span class="chip chip--agotado">Agotado</span>
                }
                @if (hasPartialConfirmation(item)) {
                  <span class="chip chip--partial">Parcial: {{ confirmedQty(item) }} de {{ item.quantity }}</span>
                }
              </div>
            </div>

            <div class="product-side">
              <div class="price product-price">
                <span class="label">Precio clienta</span>
                <span class="value">{{ formatCurrency(item.price_clienta ?? item.price_public ?? null) || itemPriceLabel(item) }}</span>
              </div>
              @if (isConfirmItemsPhase(current)) {
                <div
                  class="product-actions"
                  [class.product-actions--resolved]="isConfirmedConfirmation(item)"
                  (click)="$event.stopPropagation()"
                >
                  @if (isConfirmedConfirmation(item)) {
                    <span class="product-confirmed-check" aria-label="Confirmado">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path d="m5 13 4 4L19 7"></path>
                      </svg>
                    </span>
                  } @else {
                    @if (hasInsufficientStock(item) && !isOutOfStockConfirmation(item)) {
                      <div class="qty-inline card-qty-inline" [attr.aria-label]="'Cantidad confirmable para ' + item.title">
                        <button type="button" class="qty-mini" [disabled]="isQuickConfirming(item)" (click)="decreaseCardConfirmedQty(item)">-</button>
                        <span class="qty-mini-value">{{ getCardDraftConfirmedQty(item) }} / {{ item.quantity }}</span>
                        <button type="button" class="qty-mini" [disabled]="isQuickConfirming(item)" (click)="increaseCardConfirmedQty(item)">+</button>
                      </div>
                    }
                    <button
                      type="button"
                      class="btn card-action-btn card-action-btn--confirm"
                      [disabled]="isQuickConfirming(item)"
                      (click)="confirmarItem(item)"
                    >
                      Confirmar
                    </button>
                    @if (!isOutOfStockConfirmation(item)) {
                      <button
                        type="button"
                        class="btn card-action-btn card-action-btn--out"
                        [class.active]="isOutOfStockConfirmation(item)"
                        [disabled]="isQuickConfirming(item)"
                        (click)="marcarAgotado(item)"
                      >
                        Agotar
                      </button>
                    }
                  }
                </div>
              }
              @if (allowedCapabilities(current, userRole()).canRegisterReception) {
                <button type="button" class="btn ghost" (click)="receiveItem(current, item)">Registrar recepciÃ³n/QA</button>
              }
              @if (allowedCapabilities(current, userRole()).canPack) {
                <button type="button" class="btn ghost" (click)="markPacked(current, item)">Empacar</button>
              }
              <div class="card-delete-wrap">
                <button
                  type="button"
                  class="btn btn--danger btn--icon-delete"
                  (click)="removeItem(current, item)"
                  aria-label="Quitar producto"
                  [disabled]="!canEditItems(current)"
                >
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="M3 6h18"></path>
                    <path d="M8 6V4h8v2"></path>
                    <path d="M7 6l1 14h8l1-14"></path>
                  </svg>
                </button>
              </div>
            </div>
            @if (hasInsufficientStock(item)) {
              <span class="stock-warning-micro">âš ï¸ Solo {{ availableStock(item) }} disponibles</span>
            }
          </article>
        }
        @if (current.items.length === 0) {
          <p class="muted">AÃºn no hay productos en este pedido.</p>
        }
      </div>
    </section>

    @if (allowedCapabilities(current, userRole()).canCreatePackages) {
      <section class="panel package-shell" id="paquetes" #packagesSection>
        <div class="panel-head">
          <h2>Paquetes</h2>
          <div class="panel-actions">
            <button
              type="button"
              class="btn primary with-icon"
              [disabled]="requiresPlannedPackages(current)"
              [attr.title]="requiresPlannedPackages(current) ? 'Define paquetes planificados para continuar' : null"
              (click)="createPackage(current)"
            >
              <span class="btn-icon" aria-hidden="true">+</span>
              Crear paquete
            </button>
            @if (requiresPlannedPackages(current)) {
              <span class="muted small">Define paquetes planificados</span>
            }
          </div>
        </div>

        <div class="packages">
          @for (pkg of current.packages; track pkg.package_id) {
            <article class="package">
              <div class="package-top">
                <div>
                  <p class="eyebrow">{{ packageDisplayLabel(current, pkg) }}</p>
                  <p class="muted">{{ pkg.item_ids.length }} productos Â· {{ pkg.state }}</p>
                </div>
                <span class="chip">{{ qrPlaceholder(current, pkg) }}</span>
              </div>
              @if (debugMode()) {
                <div class="qr-block">
                  <p class="muted">QR data</p>
                  <code>{{ packageCode(current, pkg) }}</code>
                </div>
              }
              @if (allowedCapabilities(current, userRole()).canPrintLabels) {
                <button type="button" class="btn ghost" (click)="printLabel(current, pkg)">Imprimir etiqueta</button>
              }
              @if (allowedCapabilities(current, userRole()).canDeliverByPackage) {
                <button type="button" class="btn primary" (click)="deliverPackage(current, pkg)">Registrar entrega</button>
              }
              @if (allowedCapabilities(current, userRole()).canAssignItemsToPackages) {
                <button type="button" class="btn ghost" (click)="closePackage(current, pkg)">Cerrar paquete</button>
              }
            </article>
          }

          @if (current.packages.length === 0) {
            <p class="muted package-empty-note">Sin paquetes todavÃ­a. Genera uno al terminar de empacar.</p>
          }
        </div>

        @if (allowedCapabilities(current, userRole()).canAssignItemsToPackages && current.packages.length > 0) {
          <div class="assignment">
            <div class="panel-actions">
              <select class="input" [(ngModel)]="selectedPackageId">
                <option [ngValue]="null">Selecciona un paquete</option>
                @for (pkg of current.packages; track pkg.package_id) {
                  <option [ngValue]="pkg.package_id">{{ packageDisplayLabel(current, pkg) }}</option>
                }
              </select>
              <button type="button" class="btn ghost" (click)="autoDistribute(current)">Auto-distribuir</button>
            </div>
            @if (selectedPackageId()) {
              <div class="items">
                @for (item of current.items; track item.item_id) {
                  <label class="assign-row">
                    <input
                      type="checkbox"
                      [checked]="isItemAssigned(current, selectedPackageId(), item.item_id)"
                      (change)="toggleItemAssignment(current, selectedPackageId()!, item, $any($event.target).checked)"
                    />
                    <span>{{ item.title }} Â· {{ item.quantâ€¦2774 tokens truncatedâ€¦                  [class.active]="item.confirmation_state === 'out_of_stock'"
                          [attr.aria-pressed]="item.confirmation_state === 'out_of_stock'"
                          (click)="markOutOfStock(current, item)"
                          [disabled]="current.items.length === 0"
                        >
                          <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                            <path d="M12 9v4"></path>
                            <path d="M12 17h.01"></path>
                          </svg>
                          Sin stock
                        </button>
                      </div>
                    </article>
                  }
                </div>
              </div>
            }
          </div>
          @if (current.items.length > 0) {
            <div class="confirm-footer">
              <div class="confirm-footer-text">
                <p class="confirm-footer-title">
                  {{ resolvedItems(current) }}/{{ totalItems(current) }} resueltos
                </p>
                <p class="muted small">
                  Confirmadas {{ confirmedPieces(current) }} Â· Sin stock {{ outOfStockPieces(current) }} Â· Pendientes {{ pendingPieces(current) }}
                </p>
              </div>
              <button type="button" class="btn ghost" (click)="closeActionModal()">Cancelar</button>
              <button
                type="button"
                class="btn primary confirm-submit-btn"
                [disabled]="!allItemsResolved(current) || actionSaving()"
                (click)="confirmExistences(current)"
              >
                {{ actionSaving() ? "Guardando..." : "Confirmar existencias" }}
              </button>
            </div>
          }
          </section>
        }

        @if (actionContext()?.actionId === "pack") {
          <div class="items">
            @for (item of current.items; track item.item_id) {
              <article class="item-card compact">
                <div class="item-info">
                  <p class="item-title">{{ item.title }}</p>
                  <p class="muted">{{ item.variant || "Variante" }} Â· {{ item.color || "Color" }}</p>
                </div>
                <div class="item-actions">
                  <button type="button" class="btn ghost" (click)="receiveItem(current, item)">Recibido/QA</button>
                  <button type="button" class="btn ghost" (click)="markMissing(current, item)">Faltante</button>
                  <button type="button" class="btn ghost" (click)="markDamaged(current, item)">DaÃ±ado</button>
                  <button type="button" class="btn ghost" (click)="markPacked(current, item)">Empacar</button>
                </div>
              </article>
            }
          </div>
        }

        @if (actionContext()?.actionId === "dispatch") {
          <p class="muted">Revisa precondiciones para preparar salida.</p>
          <ul class="checklist">
            <li [class.bad]="!canDispatch(current)">Paquetes cerrados = planificados y sin productos sin asignar.</li>
          </ul>
          <button type="button" class="btn primary" (click)="dispatchOrder(current)">Preparar salida</button>
        }

        @if (actionContext()?.actionId === "deliver") {
          <div class="packages">
            @for (pkg of current.packages; track pkg.package_id) {
              <article class="package">
                <div class="package-top">
                  <div>
                    <p class="eyebrow">{{ packageDisplayLabel(current, pkg) }}</p>
                    <p class="muted">{{ pkg.item_ids.length }} productos Â· {{ pkg.state }}</p>
                  </div>
                </div>
                <button type="button" class="btn primary" (click)="deliverPackage(current, pkg)">Registrar entrega</button>
              </article>
            }
          </div>
        }

        @if (actionContext()?.actionId === "register_payment") {
          <p class="muted">Registra el pago del pedido.</p>
          <button type="button" class="btn primary" (click)="registerPayment(current)">Registrar pago/conciliar</button>
        }

        @if (current.status === "en_ruta" && !lateChangeApproved()) {
          <button type="button" class="btn ghost" (click)="requestLateChange(current)">Solicitar cambio tardÃ­o</button>
        }

        @if (actionContext()?.actionId !== "confirm_items") {
          <button type="button" class="btn ghost" (click)="closeActionModal()">Cerrar</button>
        }
      </div>
    </div>
  }

  @if (plannedModalOpen()) {
    <div class="sheet-backdrop" (click)="closePlannedPackages()">
      <div
        class="sheet"
        role="dialog"
        aria-modal="true"
        aria-labelledby="planned-packages-title"
        aria-describedby="planned-packages-description"
        (click)="$event.stopPropagation()"
      >
        <div class="sheet-handle" aria-hidden="true"></div>
        <h2 id="planned-packages-title">Â¿CuÃ¡ntos paquetes esperas?</h2>
        <p class="muted" id="planned-packages-description">Define la cantidad para habilitar logÃ­stica.</p>
        <div class="sheet-field">
          <label>Paquetes planificados</label>
          <input type="number" min="1" class="input" [(ngModel)]="plannedPackagesInput" />
        </div>
        <div class="sheet-actions">
          <button type="button" class="btn primary" (click)="savePlannedPackages()">Guardar</button>
          <button type="button" class="btn ghost" (click)="closePlannedPackages()">Ahora no</button>
        </div>
      </div>
    </div>
  }

  @if (incidentModalOpen()) {
    <div class="sheet-backdrop" (click)="closeIncidentModal()">
      <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="incident-modal-title" (click)="$event.stopPropagation()">
        <div class="sheet-handle" aria-hidden="true"></div>
        <h2 id="incident-modal-title">Nueva incidencia</h2>
        <div class="sheet-field">
          <label>TÃ­tulo</label>
          <input class="input" type="text" [(ngModel)]="incidentTitle" />
        </div>
        <div class="sheet-field">
          <label>Tipo</label>
          <input class="input" type="text" [(ngModel)]="incidentType" />
        </div>
        <div class="sheet-field">
          <label>Severidad</label>
          <select class="input" [(ngModel)]="incidentSeverity">
            <option value="low">Baja</option>
            <option value="medium">Media</option>
            <option value="high">Alta</option>
          </select>
        </div>
        <div class="sheet-field">
          <label>Asignar a</label>
          <input class="input" type="text" [(ngModel)]="incidentAssignee" list="assigneeOptions" />
          <datalist id="assigneeOptions">
            @for (name of assigneeOptions(); track name) {
              <option [value]="name"></option>
            }
          </datalist>
        </div>
        <div class="sheet-field">
          <label>Motivo</label>
          <textarea class="input" rows="3" [(ngModel)]="incidentReason"></textarea>
        </div>
        <div class="sheet-actions">
          <button type="button" class="btn primary" [disabled]="incidentSaving()" (click)="createIncident()">Guardar</button>
          <button type="button" class="btn ghost" (click)="closeIncidentModal()">Cancelar</button>
        </div>
      </div>
    </div>
  }

  @if (resolveModalOpen()) {
    <div class="sheet-backdrop" (click)="closeResolveModal()">
      <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="resolve-modal-title" (click)="$event.stopPropagation()">
        <div class="sheet-handle" aria-hidden="true"></div>
        <h2 id="resolve-modal-title">Resolver incidencia</h2>
        <div class="sheet-field">
          <label>Nota de resoluciÃ³n</label>
          <textarea class="input" rows="3" [(ngModel)]="resolveNote"></textarea>
        </div>
        <div class="sheet-actions">
          <button type="button" class="btn primary" (click)="confirmResolve()">Confirmar</button>
          <button type="button" class="btn ghost" (click)="closeResolveModal()">Cancelar</button>
        </div>
      </div>
    </div>
  }

  @if (addItemModalOpen()) {
    <div class="sheet-backdrop" (click)="closeAddItemModal()">
      <div class="sheet full" role="dialog" aria-modal="true" aria-labelledby="add-item-modal-title" (click)="$event.stopPropagation()">
        <div class="sheet-header">
          <div class="sheet-handle" aria-hidden="true"></div>
          <h2 id="add-item-modal-title">Agregar producto</h2>
          <button type="button" class="btn ghost" (click)="closeAddItemModal()">Cerrar</button>
        </div>
        <div class="sheet-body">
          <div class="add-item">
          <div class="section-row">
            <div class="pill source-toggle">
              <label>
                <input type="radio" name="source" value="catalogo" [(ngModel)]="newItemSource" [disabled]="!canEditItems(current)" />
                CatÃ¡logo
              </label>
              <label>
                <input type="radio" name="source" value="inventario" [(ngModel)]="newItemSource" [disabled]="!canEditItems(current)" />
                Inventario
              </label>
            </div>
          </div>
          <div class="product-search">
            <div class="field">
              <label>Buscar producto</label>
              <input
                class="input"
                type="text"
                placeholder="Nombre, variante o color"
                [(ngModel)]="newItemSearch"
              (focus)="showProductList.set(true)"
              (keydown.escape)="showProductList.set(false)"
                [disabled]="!canEditItems(current)"
              />
            </div>
            @if (showProductList() && (inventorySuggestions().length > 0 || catalogSuggestions().length > 0)) {
              <div class="listbox" role="listbox" aria-label="Resultados de productos">
                @for (s of inventorySuggestions(); track s.inventory_id) {
                  <button type="button" role="option" class="listbox-option" [attr.aria-label]="'Inventario: ' + s.title" (mousedown)="$event.preventDefault(); beginProductPick(); pickInventory(s)" (touchstart)="$event.preventDefault(); beginProductPick(); pickInventory(s)" (click)="beginProductPick(); pickInventory(s)">
                    @if (s.image_urls[0]) {
                      <img class="listbox-thumb" [src]="s.image_urls[0]" alt="" />
                    } @else {
                      <div class="photo-placeholder photo-placeholder-sm" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M4 7h4l2-2h4l2 2h4v12H4z"></path>
                          <circle cx="12" cy="13" r="3"></circle>
                        </svg>
                      </div>
                    }
                    <div>
                      <div class="card-title">{{ s.title }}</div>
                      <div class="card-meta">{{ s.variant_name || s.size_label || "Variante" }} Â· {{ s.color_name || "Color" }}</div>
                    </div>
                    <span class="card-tag inv">Inventario Â· {{ s.quantity_on_hand }} pzas</span>
                  </button>
                }
                @for (c of catalogSuggestions(); track c.doc.normalized_id) {
                  <button type="button" role="option" class="listbox-option" [attr.aria-label]="'CatÃ¡logo: ' + c.doc.listing.title" (mousedown)="$event.preventDefault(); beginProductPick(); pickCatalog(c.doc, c.variant, c.color)" (touchstart)="$event.preventDefault(); beginProductPick(); pickCatalog(c.doc, c.variant, c.color)" (click)="beginProductPick(); pickCatalog(c.doc, c.variant, c.color)">
                    @if (c.image) {
                      <img class="listbox-thumb" [src]="c.image" alt="" />
                    } @else {
                      <div class="photo-placeholder photo-placeholder-sm" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M4 7h4l2-2h4l2 2h4v12H4z"></path>
                          <circle cx="12" cy="13" r="3"></circle>
                        </svg>
                      </div>
                    }
                    <div>
                      <div class="card-title">{{ c.doc.listing.title }}</div>
                      <div class="card-meta">{{ c.doc.listing.category_hint || "Sin categorÃ­a" }}</div>
                    </div>
                    <span class="card-tag cat">{{ c.variant.variant_name || '-' }} Â· {{ c.color || 'Color' }}</span>
                  </button>
                }
              </div>
            }
          </div>
          @if (selectedPreview(); as preview) {
            <div class="preview">
              @if (preview.image) {
                <img [src]="preview.image" alt="" />
              } @else {
                <div class="photo-placeholder photo-placeholder-md" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 7h4l2-2h4l2 2h4v12H4z"></path>
                    <circle cx="12" cy="13" r="3"></circle>
                  </svg>
                </div>
              }
              <div>
                <p class="preview-title">{{ preview.title }}</p>
                <p class="preview-meta">{{ preview.variant }} Â· {{ preview.color }}</p>
                @if (!selectedPreviewHasColorImage()) {
                  <span class="color-chip">Color: {{ preview.color }}</span>
                }
                <span class="preview-tag">{{ preview.source }}</span>
              </div>
            </div>
          }
          <div class="field">
            <label>Producto</label>
            <input
              class="input"
              type="text"
              [(ngModel)]="newItemTitle"
              [readonly]="lockItemFields()"
              [disabled]="!selectedPreview() || !canEditItems(current)"
            />
          </div>
          @if (catalogVariantOptions().length > 0) {
            <div class="field">
              <label>Variante / talla</label>
              <select
                class="input"
                [ngModel]="newItemVariant()"
                (ngModelChange)="onVariantChange($event)"
                [disabled]="!selectedPreview() || !canEditItems(current)"
              >
                @for (v of catalogVariantOptions(); track v) {
                  <option [value]="v">{{ v }}</option>
                }
              </select>
            </div>
          } @else {
            <div class="field">
              <label>Variante / talla</label>
              <input
                class="input"
                type="text"
                [(ngModel)]="newItemVariant"
                [readonly]="lockItemFields()"
                [disabled]="!selectedPreview() || !canEditItems(current)"
              />
            </div>
          }
          @if (catalogColorOptions().length > 0) {
            <div class="field">
              <label>Color</label>
              <select
                class="input"
                [ngModel]="newItemColor()"
                (ngModelChange)="onColorChange($event)"
                [disabled]="!selectedPreview() || !canEditItems(current)"
              >
                @for (c of catalogColorOptions(); track c) {
                  <option [value]="c">{{ c }}</option>
                }
              </select>
            </div>
          } @else {
            <div class="field">
              <label>Color</label>
              <input
                class="input"
                type="text"
                [(ngModel)]="newItemColor"
                [readonly]="lockItemFields()"
                [disabled]="!selectedPreview() || !canEditItems(current)"
              />
            </div>
          }
          <div class="field">
            <label>Cantidad</label>
            <input
              class="input"
              type="number"
              min="1"
              [(ngModel)]="newItemQty"
              [disabled]="!selectedPreview() || !canEditItems(current)"
            />
          </div>
          <div class="field">
            <label>Precio final</label>
            <div class="money" [class.money-invalid]="priceRuleInvalid()">
              <span>MXN</span>
              <input
                class="input"
                type="text"
                [value]="priceDisplayValue('final')"
                (focus)="onPriceInputFocus('final')"
                (input)="onPriceInputChange('final', $any($event.target).value)"
                (blur)="onPriceInputBlur('final')"
                [disabled]="!selectedPreview() || !canEditItems(current)"
              />
            </div>
          </div>
          <div class="field">
            <label>Precio clienta</label>
            <div class="money money-readonly" [class.money-invalid]="priceRuleInvalid()">
              <span>MXN</span>
              <input
                class="input"
                type="text"
                [value]="priceDisplayValue('clienta')"
                readonly
                disabled
              />
            </div>
          </div>
          <div class="field">
            <label>Precio costo</label>
            <div class="money money-readonly">
              <span>MXN</span>
              <input
                class="input"
                type="text"
                [value]="priceDisplayValue('costo')"
                readonly
                disabled
              />
            </div>
          </div>
        </div>
        </div>
        <div class="sheet-footer">
          <button type="button" class="btn primary" (click)="addItem(current)" [disabled]="!selectedPreview() || !canEditItems(current)">
            AÃ±adir al pedido
          </button>
          <button type="button" class="btn danger" (click)="closeAddItemModal()">Cancelar</button>
        </div>
      </div>
    </div>
  }

  @if (assignModalOpen()) {
    <div class="sheet-backdrop" (click)="closeAssignModal()">
      <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="assign-modal-title" (click)="$event.stopPropagation()">
        <div class="sheet-handle" aria-hidden="true"></div>
        <h2 id="assign-modal-title">Asignar incidencia</h2>
        <div class="sheet-field">
          <label>Asignar a</label>
          <input class="input" type="text" [(ngModel)]="incidentAssignee" list="assigneeOptions" />
          <datalist id="assigneeOptions">
            @for (name of assigneeOptions(); track name) {
              <option [value]="name"></option>
            }
          </datalist>
        </div>
        <div class="sheet-actions">
          <button type="button" class="btn primary" (click)="confirmAssign()">Confirmar</button>
          <button type="button" class="btn ghost" (click)="closeAssignModal()">Cancelar</button>
        </div>
      </div>
    </div>
  }
} @else {
  <section class="page">
    <p class="muted">No encontramos este pedido.</p>
    <button type="button" class="btn" routerLink="/main/pedidos">Volver a la lista</button>
  </section>
}



