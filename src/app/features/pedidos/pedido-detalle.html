@if (order(); as current) {
  <section class="page">
    <header class="page-head">
      <div class="page-head-main">
        <div class="page-head-topline">
          <button class="link-back link-back--icon" type="button" (click)="backToList()" aria-label="Volver">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M15 18 9 12l6-6"></path>
            </svg>
          </button>
          <div class="order-id-wrap">
            <p class="eyebrow order-id-line">Pedido {{ current.order_id }}</p>
            <button
              type="button"
              class="order-id-copy"
              aria-label="Copiar ID del pedido"
              (click)="copyOrderId(current.order_id)"
            >
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <rect x="9" y="9" width="11" height="11" rx="2"></rect>
                <path d="M5 15V6a2 2 0 0 1 2-2h9"></path>
              </svg>
            </button>
            @if (copiedOrderId()) {
              <span class="copy-toast">!Copiado!</span>
            }
          </div>
        </div>
        <h1>{{ customerName(current) }}</h1>
        <p class="muted page-updated">Actualizado {{ current.updated_at | date: "short" }}</p>
        <div class="title-row title-row--meta">
          <span class="meta-dot-pill">{{ statusLabel(current.status) }}</span>
          <span class="meta-dot-pill meta-dot-pill--location">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M12 22s7-6 7-12a7 7 0 1 0-14 0c0 6 7 12 7 12z"></path>
              <circle cx="12" cy="10" r="2.5"></circle>
            </svg>
            {{ routeName(current) }}
          </span>
        </div>
      </div>
      <div class="status-actions">
        @if (phaseAction(current); as phase) {
          <button
            type="button"
            class="btn confirm-intelligent-btn"
            [class.primary]="phase.actionId !== 'confirm_items' || isConfirmExistencesReady(current)"
            [class.ghost]="phase.actionId === 'confirm_items' && !isConfirmExistencesReady(current)"
            [disabled]="phase.actionId === 'confirm_items' && current.items.length === 0"
            (click)="openActionModal(current)"
          >
            {{ phase.actionId === "confirm_items" ? confirmExistencesActionLabel(current) : phase.label }}
          </button>
        }
      </div>
    </header>

    @if (actionToast()) {
      <div class="action-toast" role="status" aria-live="polite">{{ actionToast() }}</div>
    }

    @if (requiresPlannedPackages(current)) {
      <div class="sticky-banner">
        <div>
          <p class="eyebrow">Define paquetes planificados</p>
          <p class="muted">Necesitamos la cantidad esperada para habilitar acciones de logistica.</p>
        </div>
        <button type="button" class="btn primary" (click)="openPlannedPackages()">Definir paquetes</button>
      </div>
    }

    <section class="summary" aria-label="Resumen del pedido">
      <article class="summary-card summary-card--pieces">
        <span
          class="summary-progress-ring"
          aria-hidden="true"
          [style.--progress]="confirmedPiecesPercent(current)"
        >
          <span class="summary-progress-ring__value">
            {{ confirmedPiecesPercent(current) }}%
          </span>
        </span>
        <div>
          <p class="eyebrow">Piezas</p>
          <p class="summary-ratio">
            <strong class="summary-value">{{ confirmedPieces(current) }}</strong>
            <span>/ {{ totalPieces(current) }}</span>
          </p>
          <p class="summary-note" [class.summary-note--warning]="pendingPieces(current) > 0">
            {{ pendingPieces(current) }} pieza{{ pendingPieces(current) === 1 ? "" : "s" }} pendientes
          </p>
        </div>
      </article>

      <article class="summary-card summary-card--money">
        <p class="eyebrow">Total venta</p>
        <p class="summary-money">
          <span>MXN</span>
          <strong class="summary-value">{{ formatCurrency(totals().totalVenta) }}</strong>
        </p>
      </article>

      <article class="summary-card summary-card--money">
        <p class="eyebrow">Total clienta</p>
        <p class="summary-money">
          <span>MXN</span>
          <strong class="summary-value">{{ formatCurrency(totals().totalClienta) }}</strong>
        </p>
      </article>

      <article class="summary-card summary-card--profit">
        <p class="eyebrow">Ganancia</p>
        <p class="summary-money summary-money--profit">
          <span>MXN</span>
          <strong class="summary-value summary-value--profit">{{ formatCurrency(totals().ganancia) }}</strong>
        </p>
      </article>
    </section>

    <nav class="section-nav" aria-label="Navegacion de secciones">
      <button type="button" (click)="scrollToSection('incidencias')">Incidencias</button>
      <button type="button" (click)="scrollToSection('productos')">Productos</button>
      <button type="button" (click)="scrollToSection('paquetes')">Paquetes</button>
      <button type="button" (click)="scrollToSection('bitacora')">Bitacora</button>
    </nav>

    <section class="panel" id="incidencias" #incidentsSection>
      <div class="panel-head">
        <h2>Incidencias</h2>
        <div class="panel-actions">
          <button type="button" class="btn ghost with-icon" (click)="openIncidentModal()">
            <span class="btn-icon" aria-hidden="true">+</span>
            Nueva incidencia
          </button>
          <button type="button" class="btn link" (click)="toggleResolved()">
            {{ showResolvedIncidents() ? "Ocultar" : "Ver" }} resueltas ({{ resolvedIncidents().length }})
          </button>
        </div>
      </div>
      <div class="incidents">
        @if (openIncidents().length === 0) {
          <p class="muted">Sin incidencias abiertas.</p>
        }
        @for (inc of openIncidents(); track inc.id) {
          <article
            class="incident-card"
            [class.high]="inc.severity === 'high'"
            [class.medium]="inc.severity === 'medium'"
            [class.low]="inc.severity === 'low'"
          >
            <div class="incident-main">
              <div class="incident-head">
                <div class="incident-title-row">
                  <p class="incident-title">{{ inc.title }}</p>
                  <div class="incident-chips">
                    <span class="chip incident-chip incident-chip-type">{{ inc.type }}</span>
                    <span class="chip incident-chip incident-chip-severity">
                      {{ inc.severity === "high" ? "Alta" : inc.severity === "medium" ? "Media" : "Baja" }}
                    </span>
                  </div>
                </div>
              </div>
              <p class="incident-reason">{{ inc.reason }}</p>
              <div class="incident-meta-grid">
                <p class="incident-meta"><strong>Asignado a:</strong> {{ inc.assigneeId || "Sin asignar" }}</p>
                <p class="incident-meta"><strong>Fecha:</strong> {{ inc.createdAt | date: "short" }}</p>
                <p class="incident-meta"><strong>Admin:</strong> {{ inc.createdBy }}</p>
              </div>
              @if ((inc.evidenceUrls?.length || 0) > 0) {
                <div class="evidence">
                  <p class="evidence-count">{{ (inc.evidenceUrls?.length || 0) }} evidencia{{ (inc.evidenceUrls?.length || 0) === 1 ? "" : "s" }}</p>
                  @for (url of inc.evidenceUrls || []; track url) {
                    <a class="evidence-thumb" [href]="url" target="_blank" rel="noreferrer">
                      <img [src]="url" [alt]="'Evidencia de ' + inc.title" loading="lazy" />
                    </a>
                  }
                </div>
              }
            </div>
            <div class="incident-actions">
              <button type="button" class="btn primary" (click)="openResolveModal(inc)">Resolver</button>
              <button type="button" class="btn ghost" (click)="openAssignModal(inc)">Asignar</button>
              <label class="btn ghost file-btn">
                <input type="file" accept="image/*" (change)="attachEvidence(inc, $event)" />
                {{ uploadingEvidence()[inc.id] ? "Subiendo..." : "Adjuntar foto" }}
              </label>
              <button type="button" class="btn link incident-link" (click)="scrollToTimeline()">Ver en bitacora</button>
            </div>
          </article>
        }
      </div>
      @if (showResolvedIncidents() && resolvedIncidents().length > 0) {
        <div class="incidents resolved">
          @for (inc of resolvedIncidents(); track inc.id) {
            <article class="incident-card resolved">
              <div>
                <p class="eyebrow">{{ inc.title }} - {{ inc.type }}</p>
                <p class="muted">Resuelta {{ inc.resolvedAt | date: "short" }} - {{ inc.resolvedBy }}</p>
                @if (inc.resolutionNote) {
                  <p class="muted">{{ inc.resolutionNote }}</p>
                }
              </div>
            </article>
          }
        </div>
      }
    </section>

    <section class="panel" id="productos">
      <div class="panel-head">
        <h2>Productos</h2>
        <div class="panel-actions">
          <button type="button" class="btn primary with-icon" (click)="openAddItemModal()" [disabled]="!canEditItems(current)">
            <span class="btn-icon" aria-hidden="true">+</span>
            Agregar producto
          </button>
          <p class="muted">Escanea o cambia el estado por producto.</p>
        </div>
      </div>
      @if (current.items.length > 0) {
        <div class="products-toolbar" role="tablist" aria-label="Filtro de productos por stock">
          <button
            type="button"
            class="products-filter-btn"
            [class.active]="productStockFilter() === 'all'"
            (click)="setProductStockFilter('all')"
          >
            Todo ({{ totalItems(current) }})
          </button>
          <button
            type="button"
            class="products-filter-btn"
            [class.active]="productStockFilter() === 'out_of_stock'"
            [disabled]="outOfStockItemsCount(current) === 0"
            (click)="setProductStockFilter('out_of_stock')"
          >
            Sin stock ({{ outOfStockItemsCount(current) }})
          </button>
          <button
            type="button"
            class="products-filter-btn"
            [class.active]="productStockFilter() === 'confirmed'"
            [disabled]="confirmedItemsCount(current) === 0"
            (click)="setProductStockFilter('confirmed')"
          >
            Confirmados ({{ confirmedItemsCount(current) }})
          </button>
          <button
            type="button"
            class="products-filter-btn"
            [class.active]="productStockFilter() === 'pending'"
            [disabled]="pendingConfirmationItemsCount(current) === 0"
            (click)="setProductStockFilter('pending')"
          >
            Pendientes ({{ pendingConfirmationItemsCount(current) }})
          </button>
          @if (isConfirmItemsPhase(current) && hasPendingItems(current)) {
            <button
              type="button"
              class="products-batch-btn"
              (click)="confirmarTodoDisponible()"
              [disabled]="!canMagicConfirm(current)"
            >
              Marcar todo como disponible
            </button>
          }
        </div>
      }
      <div class="items order-item-grid">
        @for (item of filteredProductItems(current); track item.item_id) {
          <article
            class="product-card"
            [id]="productCardId(item)"
            [class.status--confirmed]="isConfirmedConfirmation(item)"
            [class.status--partial]="isConfirmedConfirmation(item) && hasPartialConfirmation(item)"
            [class.status--out]="isOutOfStockConfirmation(item)"
            [class.status--alert]="hasInsufficientStock(item) && !isOutOfStockConfirmation(item)"
          >
            <button type="button" class="btn-close" (click)="removeItem(current, item)" [disabled]="!canEditItems(current)">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 6h18"></path>
                <path stroke-linecap="round" stroke-linejoin="round" d="M8 6V4h8v2"></path>
                <path stroke-linecap="round" stroke-linejoin="round" d="M7 6l1 14h8l1-14"></path>
              </svg>
            </button>

            <div class="card-body">
              <div class="main-info">
                <button type="button" class="image-container" (click)="openImagePreview(itemImage(item) || 'https://via.placeholder.com/800?text=Producto')">
                  <img [src]="itemImage(item) || 'https://via.placeholder.com/100'" [alt]="item.title" />
                  <span class="source-tag source-text--overlay" [class.source--catalogo]="item.source === 'catalogo'">
                    {{ item.source | uppercase }}
                  </span>
                  @if (isConfirmedConfirmation(item)) {
                    <span class="pieces-state" [class.pieces-state--partial]="hasPartialConfirmation(item)" [class.pieces-state--ok]="!hasPartialConfirmation(item)">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m5 13 4 4L19 7"></path>
                      </svg>
                    </span>
                  } @else if (isOutOfStockConfirmation(item)) {
                    <span class="pieces-state pieces-state--out">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M18 6L6 18M6 6l12 12"></path>
                      </svg>
                    </span>
                  }
                </button>

                <div class="text-content">
                  <div class="title-row">
                    <h4 class="product-name">{{ item.title }}</h4>
                  </div>

                  <div class="specs-grid">
                    <div class="spec-item">
                      <svg class="icon-tiny" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M7 7h10v10H7zM7 12h10M12 7v10"/></svg>
                      <span>{{ item.variant || "Unica" }}</span>
                    </div>
                    <div class="spec-item">
                      <svg class="icon-tiny" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="9"/><path d="M12 8v8M8 12h8"/></svg>
                      <span>{{ item.color || "N/A" }}</span>
                    </div>
                    <div class="spec-status-row">
                      <div class="spec-item spec-item--pieces">
                        @if (isOutOfStockConfirmation(item)) {
                          <span>Piezas: <strong>{{ item.quantity }}</strong></span>
                        } @else if (item.quantity > 1) {
                          <span>Piezas: <strong>{{ confirmedQty(item) }}</strong> de <strong>{{ item.quantity }}</strong></span>
                        } @else {
                          <span>Piezas: <strong>{{ item.quantity }}</strong></span>
                        }
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="footer-row">
                <div class="price-stack">
                  <span class="price-label">Precio Clienta</span>
                  <span class="price-value">{{ formatCurrency(item.price_clienta ?? item.price_public ?? 0) }}</span>
                </div>

                <div class="action-stack">
                  @if (isConfirmItemsPhase(current)) {
                    <div class="button-group">
                      @if (isConfirmedConfirmation(item) && item.quantity > 1) {
                        <div class="confirmed-counter" [attr.aria-label]="'Confirmados para ' + item.title">
                          <button
                            type="button"
                            class="confirmed-counter__btn"
                            [disabled]="isQuickConfirming(item)"
                            (click)="decreaseConfirmedCounter(item)"
                          >
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M6 12h12"></path>
                            </svg>
                          </button>
                          <span class="confirmed-counter__value">{{ getCardDraftConfirmedQty(item) }} / {{ item.quantity }}</span>
                          <button
                            type="button"
                            class="confirmed-counter__btn"
                            [disabled]="isQuickConfirming(item)"
                            (click)="increaseConfirmedCounter(item)"
                          >
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12M6 12h12"></path>
                            </svg>
                          </button>
                        </div>
                      } @else if (!isConfirmedConfirmation(item)) {
                        <button class="btn-main btn-confirm" (click)="confirmarItem(item)">Marcar <span class="btn-confirm-word">Disponible</span></button>
                      }
                      @if (!isOutOfStockConfirmation(item)) {
                        <button class="btn-sub btn-out" (click)="marcarAgotado(item)">Marcar <span class="btn-out-word">Agotado</span></button>
                      }
                    </div>
                  } @else if (isSupplierManagedItem(item) && !isSupplierItemReceived(current, item) && isConfirmedConfirmation(item)) {
                    <button type="button" class="btn card-receive-btn" [disabled]="isItemActionLoading(item)" (click)="receiveItem(current, item)">
                      @if (isItemActionLoading(item)) {
                        <span class="btn-spinner" aria-hidden="true"></span>
                        Procesando...
                      } @else {
                        Recibir proveedor
                      }
                    </button>
                  }
                </div>
              </div>
            </div>
          </article>
        }

        @if (current.items.length === 0) {
          <div class="empty-state">
            <p>Aun no hay productos en este pedido.</p>
          </div>
        }
      </div>
    </section>

    @if (allowedCapabilities(current, userRole()).canCreatePackages) {
      <section class="panel package-shell" id="paquetes" #packagesSection>
        <div class="panel-head">
          <h2>Paquetes</h2>
          <div class="panel-actions">
            <button
              type="button"
              class="btn primary with-icon"
              [disabled]="requiresPlannedPackages(current)"
              [attr.title]="requiresPlannedPackages(current) ? 'Define paquetes planificados para continuar' : null"
              (click)="createPackage(current)"
            >
              <span class="btn-icon" aria-hidden="true">+</span>
              Crear paquete
            </button>
            @if (requiresPlannedPackages(current)) {
              <span class="muted small">Define paquetes planificados</span>
            }
          </div>
        </div>

        <div class="packages">
          @for (pkg of current.packages; track pkg.package_id) {
            <article class="package">
              <div class="package-top">
                <div>
                  <p class="eyebrow">{{ packageDisplayLabel(current, pkg) }}</p>
                  <p class="muted">{{ pkg.item_ids.length }} productos - {{ pkg.state }}</p>
                </div>
                <span class="chip">{{ qrPlaceholder(current, pkg) }}</span>
              </div>
              @if (debugMode()) {
                <div class="qr-block">
                  <p class="muted">QR data</p>
                  <code>{{ packageCode(current, pkg) }}</code>
                </div>
              }
              @if (allowedCapabilities(current, userRole()).canPrintLabels) {
                <button type="button" class="btn ghost" (click)="printLabel(current, pkg)">Imprimir etiqueta</button>
              }
              @if (allowedCapabilities(current, userRole()).canDeliverByPackage) {
                <button type="button" class="btn primary" (click)="deliverPackage(current, pkg)">Registrar entrega</button>
              }
              @if (allowedCapabilities(current, userRole()).canAssignItemsToPackages) {
                <button type="button" class="btn ghost" (click)="closePackage(current, pkg)">Cerrar paquete</button>
              }
            </article>
          }

          @if (current.packages.length === 0) {
            <p class="muted package-empty-note">Sin paquetes todavia. Genera uno al terminar de empacar.</p>
          }
        </div>

        @if (allowedCapabilities(current, userRole()).canAssignItemsToPackages && current.packages.length > 0) {
          <div class="assignment">
            <div class="panel-actions">
              <select class="input" [(ngModel)]="selectedPackageId">
                <option [ngValue]="null">Selecciona un paquete</option>
                @for (pkg of current.packages; track pkg.package_id) {
                  <option [ngValue]="pkg.package_id">{{ packageDisplayLabel(current, pkg) }}</option>
                }
              </select>
              <button type="button" class="btn ghost" (click)="autoDistribute(current)">Auto-distribuir</button>
            </div>
            @if (selectedPackageId()) {
              <div class="items">
                @for (item of current.items; track item.item_id) {
                  <label class="assign-row">
                    <input
                      type="checkbox"
                      [checked]="isItemAssigned(current, selectedPackageId(), item.item_id)"
                      (change)="toggleItemAssignment(current, selectedPackageId()!, item, $any($event.target).checked)"
                    />
                    <span>{{ item.title }} - {{ item.quantity }} pza</span>
                  </label>
                }
              </div>
            }
          </div>
        }
      </section>
    } @else {
      <section class="panel locked package-shell" id="paquetes" #packagesSection>
        <div class="panel-head">
          <h2>Paquetes</h2>
        </div>
        <p class="muted package-empty-note">Los paquetes se habilitan al recibir/QA o empaque.</p>
      </section>
    }

    <section class="panel" id="bitacora" #timelineSection>
      <div class="panel-head">
        <h2>Bitacora</h2>
      </div>
      @if (events().length > 0) {
        <ol class="timeline">
          @for (event of events(); track event.id) {
            <li class="timeline-item">
              <p class="eyebrow timeline-date">{{ event.createdAt | date: "short" }} - {{ relativeTime(event.createdAt) }}</p>
              <p>{{ event.message }}</p>
              <p class="muted">{{ eventActor(event) }}</p>
            </li>
          }
        </ol>
        @if (eventsHasMore()) {
          <button type="button" class="btn ghost with-icon" (click)="loadEvents()" [disabled]="eventsLoading()">
            <span class="btn-icon" aria-hidden="true">?</span>
            {{ eventsLoading() ? "Cargando..." : "Cargar mas" }}
          </button>
        }
      } @else {
        <ol class="timeline">
          @for (event of current.timeline; track event.id) {
            <li class="timeline-item">
              <p class="eyebrow timeline-date">{{ event.created_at | date: "short" }} - {{ relativeTime(event.created_at) }}</p>
              <p>{{ event.label }}</p>
              <p class="muted">{{ eventActor(event) }}</p>
            </li>
          }
        </ol>
      }
    </section>

    <div class="sticky-action-bar" [class.show]="showStickyFooter()">
      <div class="sticky-action-meta">
        <p class="sticky-name">{{ customerName(current) }}</p>
        <p class="sticky-total">Total: {{ formatCurrency(totals().totalClienta) }}</p>
      </div>
      <button
        type="button"
        class="btn sticky-confirm-btn confirm-intelligent-btn"
        [class.primary]="isConfirmExistencesReady(current)"
        [class.ghost]="!isConfirmExistencesReady(current)"
        [disabled]="!isConfirmItemsPhase(current) || current.items.length === 0"
        (click)="openActionModal(current)"
      >
        {{ confirmExistencesActionLabel(current) }}
      </button>
    </div>
    @if (shouldShowStockFab(current)) {
      <button type="button" class="stock-fab" (click)="scrollToFirstInsufficientProduct(current)">
        {{ insufficientItemsCount(current) }} errores
      </button>
    }
  </section>

  @if (actionModalOpen() && actionContext()) {
    <div class="sheet-backdrop" (click)="closeActionModal()">
      <div
        class="sheet"
        role="dialog"
        aria-modal="true"
        [class.sheet-confirm-items]="actionContext()?.actionId === 'confirm_items'"
        [attr.aria-labelledby]="actionContext()?.actionId === 'confirm_items' ? 'confirm-items-title' : 'action-modal-title'"
        [attr.aria-describedby]="actionContext()?.actionId === 'confirm_items' ? 'confirm-items-description' : null"
        (click)="$event.stopPropagation()"
      >
        <div class="sheet-handle" aria-hidden="true"></div>
        @if (actionContext()?.actionId !== "confirm_items") {
          <h2 id="action-modal-title">{{ actionContext()?.label }}</h2>
        }
        @if (actionError()) {
          <div class="sheet-warning">
            <p class="eyebrow">Atencion</p>
            <p>{{ actionError() }}</p>
          </div>
        }

        @if (actionContext()?.actionId === "confirm_items") {
          <section class="confirm-shell" id="confirm-items-description">
            <header class="confirm-header" [class.confirm-header-resolved]="allItemsResolved(current)">
              <div class="confirm-header-main">
                <p class="eyebrow">Control de inventario</p>
                <h2 id="confirm-items-title">Confirmar existencias</h2>
                @if (!allItemsResolved(current)) {
                  <p class="muted">Valida cada pieza para poder cerrar esta etapa.</p>
                }
              </div>
              @if (allItemsResolved(current)) {
                <div class="confirm-header-state" aria-label="Resuelto">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="m5 13 4 4L19 7"></path>
                  </svg>
                </div>
              }

            </header>

            @if (current.items.length > 0) {
              <div class="confirm-kpis">
                <article class="confirm-kpi kpi-confirmed">
                  <p class="kpi-label">Confirmadas</p>
                  <p class="kpi-value">{{ confirmedPieces(current) }}</p>
                </article>
                <article class="confirm-kpi kpi-out">
                  <p class="kpi-label">Sin stock</p>
                  <p class="kpi-value">{{ outOfStockPieces(current) }}</p>
                </article>
                <article class="confirm-kpi kpi-pending">
                  <p class="kpi-label">Pendientes</p>
                  <p class="kpi-value">{{ pendingPieces(current) }}</p>
                </article>
              </div>
            }

          @if (current.items.length > 0) {
            <div class="confirm-summary">
              <div class="confirm-progress" role="progressbar" [attr.aria-valuenow]="resolvedPieces(current)" aria-valuemin="0" [attr.aria-valuemax]="totalPieces(current)">
                <span class="confirm-progress-bar" [style.width.%]="totalPieces(current) > 0 ? (resolvedPieces(current) * 100) / totalPieces(current) : 0"></span>
              </div>
            </div>
          }
          @if (current.items.length > 0) {
            <div class="confirm-items-list">
              @for (group of groupedItemsBySupplier(current); track group.supplierId) {
                <div class="supplier-head" [class.resolved]="groupPendingCount(group.items) === 0">
                  <div class="supplier-meta">
                    <p class="supplier-title">{{ groupDisplayName(group) }}</p>
                    <div class="supplier-stats">
                      @if (groupOutOfStockCount(group.items) > 0) {
                        <span class="stat-chip danger">Sin Stock {{ groupOutOfStockCount(group.items) }}</span>
                      }
                      @if (groupConfirmedCount(group.items) > 0) {
                        <span class="stat-chip success">Confirmados {{ groupConfirmedCount(group.items) }}</span>
                      }
                      @if (groupPendingCount(group.items) > 0) {
                        <span class="stat-chip pending">Pendientes {{ groupPendingCount(group.items) }}</span>
                      }
                    </div>
                  </div>
                </div>
              }
            </div>
          }
          @if (current.items.length > 0) {
            <div class="confirm-footer">
              <div class="confirm-footer-text">
                <p class="confirm-footer-title">
                  {{ confirmedPieces(current) + outOfStockPieces(current) }}/{{ totalPieces(current) }} piezas resueltas
                </p>
              </div>
              <button type="button" class="btn ghost" (click)="closeActionModal()">Cancelar</button>
              <button
                type="button"
                class="btn primary confirm-submit-btn"
                [class.confirm-submit-btn--blocked]="pendingPieces(current) > 0 && !actionSaving()"
                [attr.aria-disabled]="pendingPieces(current) > 0 ? 'true' : null"
                [disabled]="actionSaving()"
                (click)="onConfirmExistencesClick(current)"
              >
                {{ actionSaving() ? "Guardando..." : "Confirmar existencias" }}
              </button>
            </div>
          }
          </section>
        }

        @if (actionContext()?.actionId === "pack") {
          @if (!canStartPacking(current)) {
            <div class="sheet-warning">
              <p class="eyebrow">Bloqueo operativo</p>
              <p>Faltan {{ packBlockedCount(current) }} item(s) por recibir de proveedor antes de empacar.</p>
            </div>
          }
          <div class="items">
            @for (item of current.items; track item.item_id) {
              <article class="item-card compact">
                <div class="item-info">
                  <p class="item-title">{{ item.title }}</p>
                  <p class="muted">{{ item.variant || "Variante" }} - {{ item.color || "Color" }}</p>
                </div>
                <div class="item-actions">
                  <button type="button" class="btn ghost" [disabled]="isItemActionLoading(item)" (click)="receiveItem(current, item)">
                    @if (isItemActionLoading(item)) {
                      <span class="btn-spinner" aria-hidden="true"></span>
                      Procesando...
                    } @else {
                      {{ isSupplierManagedItem(item) ? "Recibir proveedor" : "Recibido/QA" }}
                    }
                  </button>
                  <button type="button" class="btn ghost" (click)="markMissing(current, item)">Faltante</button>
                  <button type="button" class="btn ghost" (click)="markDamaged(current, item)">Danado</button>
                  <button type="button" class="btn ghost" [disabled]="!isItemReadyForPack(current, item) || isItemActionLoading(item)" (click)="markPacked(current, item)">
                    @if (isItemActionLoading(item)) {
                      <span class="btn-spinner" aria-hidden="true"></span>
                      Empacando...
                    } @else {
                      Empacar
                    }
                  </button>
                </div>
              </article>
            }
          </div>
        }

        @if (actionContext()?.actionId === "supplier_followup") {
          <p class="muted">Todas las existencias ya fueron confirmadas. Marca cuando el proveedor pase a tr√°nsito.</p>
          <button type="button" class="btn primary" [disabled]="actionSaving()" (click)="markInTransit(current)">
            {{ actionSaving() ? "Guardando..." : "Marcar en transito proveedor" }}
          </button>
        }

        @if (actionContext()?.actionId === "dispatch") {
          <p class="muted">Revisa precondiciones para preparar salida.</p>
          <ul class="checklist">
            <li [class.bad]="!canDispatch(current)">Paquetes cerrados = planificados y sin productos sin asignar.</li>
          </ul>
          <button type="button" class="btn primary" (click)="dispatchOrder(current)">Preparar salida</button>
        }

        @if (actionContext()?.actionId === "deliver") {
          <div class="packages">
            @for (pkg of current.packages; track pkg.package_id) {
              <article class="package">
                <div class="package-top">
                  <div>
                    <p class="eyebrow">{{ packageDisplayLabel(current, pkg) }}</p>
                    <p class="muted">{{ pkg.item_ids.length }} productos - {{ pkg.state }}</p>
                  </div>
                </div>
                <button type="button" class="btn primary" (click)="deliverPackage(current, pkg)">Registrar entrega</button>
              </article>
            }
          </div>
        }

        @if (actionContext()?.actionId === "register_payment") {
          <p class="muted">Registra el pago del pedido.</p>
          <button type="button" class="btn primary" (click)="registerPayment(current)">Registrar pago/conciliar</button>
        }

        @if (current.status === "en_ruta" && !lateChangeApproved()) {
          <button type="button" class="btn ghost" (click)="requestLateChange(current)">Solicitar cambio tardio</button>
        }

        @if (actionContext()?.actionId !== "confirm_items") {
          <button type="button" class="btn ghost" (click)="closeActionModal()">Cerrar</button>
        }
      </div>
    </div>
  }

  @if (plannedModalOpen()) {
    <div class="sheet-backdrop" (click)="closePlannedPackages()">
      <div
        class="sheet"
        role="dialog"
        aria-modal="true"
        aria-labelledby="planned-packages-title"
        aria-describedby="planned-packages-description"
        (click)="$event.stopPropagation()"
      >
        <div class="sheet-handle" aria-hidden="true"></div>
        <h2 id="planned-packages-title">?Cuantos paquetes esperas?</h2>
        <p class="muted" id="planned-packages-description">Define la cantidad para habilitar logistica.</p>
        <div class="sheet-field">
          <label>Paquetes planificados</label>
          <input type="number" min="1" class="input" [(ngModel)]="plannedPackagesInput" />
        </div>
        <div class="sheet-actions">
          <button type="button" class="btn primary" (click)="savePlannedPackages()">Guardar</button>
          <button type="button" class="btn ghost" (click)="closePlannedPackages()">Ahora no</button>
        </div>
      </div>
    </div>
  }

  @if (imagePreviewUrl(); as previewUrl) {
    <div class="image-lightbox" (click)="closeImagePreview()">
      <div class="image-lightbox-dialog" role="dialog" aria-modal="true" aria-label="Vista previa de imagen" (click)="$event.stopPropagation()">
        @if (imagePreviewLoading()) {
          <div class="image-lightbox-loader" aria-label="Cargando imagen"></div>
        }
        <img
          [src]="previewUrl"
          alt="Vista previa del producto"
          [class.is-loading]="imagePreviewLoading()"
          (load)="onPreviewImageLoaded()"
          (error)="onPreviewImageError()"
        />
      </div>
    </div>
  }

  @if (incidentModalOpen()) {
    <div class="sheet-backdrop" (click)="closeIncidentModal()">
      <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="incident-modal-title" (click)="$event.stopPropagation()">
        <div class="sheet-handle" aria-hidden="true"></div>
        <h2 id="incident-modal-title">Nueva incidencia</h2>
        <div class="sheet-field">
          <label>Titulo</label>
          <input class="input" type="text" [(ngModel)]="incidentTitle" />
        </div>
        <div class="sheet-field">
          <label>Tipo</label>
          <select class="input" [(ngModel)]="incidentType">
            @for (type of incidentTypeOptions; track type) {
              <option [value]="type">{{ type }}</option>
            }
          </select>
        </div>
        <div class="sheet-field">
          <label>Severidad</label>
          <select class="input" [(ngModel)]="incidentSeverity">
            <option value="low">Baja</option>
            <option value="medium">Media</option>
            <option value="high">Alta</option>
          </select>
        </div>
        <div class="sheet-field">
          <label>Asignar a</label>
          <input class="input" type="text" [(ngModel)]="incidentAssignee" list="assigneeOptions" />
          <datalist id="assigneeOptions">
            @for (name of assigneeOptions(); track name) {
              <option [value]="name"></option>
            }
          </datalist>
        </div>
        <div class="sheet-field">
          <label>Motivo</label>
          <textarea class="input" rows="3" [(ngModel)]="incidentReason"></textarea>
        </div>
        <div class="sheet-actions">
          <button type="button" class="btn primary" [disabled]="incidentSaving()" (click)="createIncident()">Guardar</button>
          <button type="button" class="btn ghost" (click)="closeIncidentModal()">Cancelar</button>
        </div>
      </div>
    </div>
  }

  @if (resolveModalOpen()) {
    <div class="sheet-backdrop" (click)="closeResolveModal()">
      <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="resolve-modal-title" (click)="$event.stopPropagation()">
        <div class="sheet-handle" aria-hidden="true"></div>
        <h2 id="resolve-modal-title">Resolver incidencia</h2>
        <div class="sheet-field">
          <label>Nota de resolucion</label>
          <textarea class="input" rows="3" [(ngModel)]="resolveNote"></textarea>
        </div>
        <div class="sheet-actions">
          <button type="button" class="btn primary" (click)="confirmResolve()">Confirmar</button>
          <button type="button" class="btn ghost" (click)="closeResolveModal()">Cancelar</button>
        </div>
      </div>
    </div>
  }

  @if (addItemModalOpen()) {
    <div class="sheet-backdrop" (click)="closeAddItemModal()">
      <div class="sheet full" role="dialog" aria-modal="true" aria-labelledby="add-item-modal-title" (click)="$event.stopPropagation()">
        <div class="sheet-header">
          <div class="sheet-handle" aria-hidden="true"></div>
          <h2 id="add-item-modal-title">Agregar producto</h2>
          <button type="button" class="btn ghost" (click)="closeAddItemModal()">Cerrar</button>
        </div>
        <div class="sheet-body">
          <div class="add-item">
          <div class="section-row">
            <div class="pill source-toggle">
              <label>
                <input type="radio" name="source" value="catalogo" [(ngModel)]="newItemSource" [disabled]="!canEditItems(current)" />
                Catalogo
              </label>
              <label>
                <input type="radio" name="source" value="inventario" [(ngModel)]="newItemSource" [disabled]="!canEditItems(current)" />
                Inventario
              </label>
            </div>
          </div>
          <div class="product-search">
            <div class="field">
              <label>Buscar producto</label>
              <input
                #productSearchInput
                class="input"
                type="text"
                placeholder="Nombre, variante o color"
                [(ngModel)]="newItemSearch"
              (focus)="showProductList.set(true)"
              (keydown.escape)="showProductList.set(false)"
                [disabled]="!canEditItems(current)"
              />
            </div>
            @if (showProductList() && (inventorySuggestions().length > 0 || catalogSuggestions().length > 0)) {
              <div class="listbox" role="listbox" aria-label="Resultados de productos">
                @for (s of inventorySuggestions(); track s.inventory_id) {
                  <button type="button" role="option" class="listbox-option" [attr.aria-label]="'Inventario: ' + s.title" (mousedown)="$event.preventDefault(); beginProductPick(); pickInventory(s)" (touchstart)="$event.preventDefault(); beginProductPick(); pickInventory(s)" (click)="beginProductPick(); pickInventory(s)">
                    @if (s.image_urls[0]) {
                      <img class="listbox-thumb" [src]="s.image_urls[0]" alt="" />
                    } @else {
                      <div class="photo-placeholder photo-placeholder-sm" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M4 7h4l2-2h4l2 2h4v12H4z"></path>
                          <circle cx="12" cy="13" r="3"></circle>
                        </svg>
                      </div>
                    }
                    <div>
                      <div class="card-title">{{ s.title }}</div>
                      <div class="card-meta">{{ s.variant_name || s.size_label || "Variante" }} - {{ s.color_name || "Color" }}</div>
                    </div>
                    <span class="card-tag inv">Inventario - {{ s.quantity_on_hand }} pzas</span>
                  </button>
                }
                @for (c of catalogSuggestions(); track c.doc.normalized_id) {
                  <button type="button" role="option" class="listbox-option" [attr.aria-label]="'Catalogo: ' + c.doc.listing.title" (mousedown)="$event.preventDefault(); beginProductPick(); pickCatalog(c.doc, c.variant, c.color)" (touchstart)="$event.preventDefault(); beginProductPick(); pickCatalog(c.doc, c.variant, c.color)" (click)="beginProductPick(); pickCatalog(c.doc, c.variant, c.color)">
                    @if (c.image) {
                      <img class="listbox-thumb" [src]="c.image" alt="" />
                    } @else {
                      <div class="photo-placeholder photo-placeholder-sm" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M4 7h4l2-2h4l2 2h4v12H4z"></path>
                          <circle cx="12" cy="13" r="3"></circle>
                        </svg>
                      </div>
                    }
                    <div>
                      <div class="card-title">{{ c.doc.listing.title }}</div>
                      <div class="card-meta">{{ c.doc.listing.category_hint || "Sin categoria" }}</div>
                    </div>
                    <span class="card-tag cat">{{ c.variant.variant_name || '-' }} - {{ c.color || 'Color' }}</span>
                  </button>
                }
              </div>
            }
          </div>
          @if (selectedPreview(); as preview) {
            <div class="preview">
              @if (preview.image) {
                <img [src]="preview.image" alt="" />
              } @else {
                <div class="photo-placeholder photo-placeholder-md" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 7h4l2-2h4l2 2h4v12H4z"></path>
                    <circle cx="12" cy="13" r="3"></circle>
                  </svg>
                </div>
              }
              <div>
                <p class="preview-title">{{ preview.title }}</p>
                <p class="preview-meta">{{ preview.variant }} - {{ preview.color }}</p>
                @if (!selectedPreviewHasColorImage()) {
                  <span class="color-chip">Color: {{ preview.color }}</span>
                }
                <span class="preview-tag">{{ preview.source }}</span>
              </div>
            </div>
          }
          <div class="field">
            <label>Producto</label>
            <input
              class="input"
              type="text"
              [(ngModel)]="newItemTitle"
              [readonly]="lockItemFields()"
              [disabled]="!selectedPreview() || !canEditItems(current)"
            />
          </div>
          @if (catalogVariantOptions().length > 0) {
            <div class="field">
              <label>Variante / talla</label>
              <select
                class="input"
                [ngModel]="newItemVariant()"
                (ngModelChange)="onVariantChange($event)"
                [disabled]="!selectedPreview() || !canEditItems(current)"
              >
                @for (v of catalogVariantOptions(); track v) {
                  <option [value]="v">{{ v }}</option>
                }
              </select>
            </div>
          } @else {
            <div class="field">
              <label>Variante / talla</label>
              <input
                class="input"
                type="text"
                [(ngModel)]="newItemVariant"
                [readonly]="lockItemFields()"
                [disabled]="!selectedPreview() || !canEditItems(current)"
              />
            </div>
          }
          @if (catalogColorOptions().length > 0) {
            <div class="field">
              <label>Color</label>
              <select
                class="input"
                [ngModel]="newItemColor()"
                (ngModelChange)="onColorChange($event)"
                [disabled]="!selectedPreview() || !canEditItems(current)"
              >
                @for (c of catalogColorOptions(); track c) {
                  <option [value]="c">{{ c }}</option>
                }
              </select>
            </div>
          } @else {
            <div class="field">
              <label>Color</label>
              <input
                class="input"
                type="text"
                [(ngModel)]="newItemColor"
                [readonly]="lockItemFields()"
                [disabled]="!selectedPreview() || !canEditItems(current)"
              />
            </div>
          }
          <div class="field">
            <label>Cantidad</label>
            <input
              class="input"
              type="number"
              min="1"
              [(ngModel)]="newItemQty"
              [disabled]="!selectedPreview() || !canEditItems(current)"
            />
          </div>
          <div class="field">
            <label>Precio final</label>
            <div class="money" [class.money-invalid]="priceRuleInvalid()">
              <span>MXN</span>
              <input
                class="input"
                type="text"
                [value]="priceDisplayValue('final')"
                (focus)="onPriceInputFocus('final')"
                (input)="onPriceInputChange('final', $any($event.target).value)"
                (blur)="onPriceInputBlur('final')"
                [disabled]="!selectedPreview() || !canEditItems(current)"
              />
            </div>
          </div>
          <div class="field">
            <label>Precio clienta</label>
            <div class="money money-readonly" [class.money-invalid]="priceRuleInvalid()">
              <span>MXN</span>
              <input
                class="input"
                type="text"
                [value]="priceDisplayValue('clienta')"
                readonly
                disabled
              />
            </div>
          </div>
          <div class="field">
            <label>Precio costo</label>
            <div class="money money-readonly">
              <span>MXN</span>
              <input
                class="input"
                type="text"
                [value]="priceDisplayValue('costo')"
                readonly
                disabled
              />
            </div>
          </div>
        </div>
        </div>
        <div class="sheet-footer">
          <button type="button" class="btn primary" (click)="addItem(current)" [disabled]="!selectedPreview() || !canEditItems(current)">
            Anadir al pedido
          </button>
          <button type="button" class="btn danger" (click)="closeAddItemModal()">Cancelar</button>
        </div>
      </div>
    </div>
  }

  @if (assignModalOpen()) {
    <div class="sheet-backdrop" (click)="closeAssignModal()">
      <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="assign-modal-title" (click)="$event.stopPropagation()">
        <div class="sheet-handle" aria-hidden="true"></div>
        <h2 id="assign-modal-title">Asignar incidencia</h2>
        <div class="sheet-field">
          <label>Asignar a</label>
          <input class="input" type="text" [(ngModel)]="incidentAssignee" list="assigneeOptions" />
          <datalist id="assigneeOptions">
            @for (name of assigneeOptions(); track name) {
              <option [value]="name"></option>
            }
          </datalist>
        </div>
        <div class="sheet-actions">
          <button type="button" class="btn primary" (click)="confirmAssign()">Confirmar</button>
          <button type="button" class="btn ghost" (click)="closeAssignModal()">Cancelar</button>
        </div>
      </div>
    </div>
  }
} @else {
  <section class="page">
    <p class="muted">No encontramos este pedido.</p>
    <button type="button" class="btn" routerLink="/main/pedidos">Volver a la lista</button>
  </section>
}
