@if (order(); as current) {
  <section class="page">
    <header class="page-head">
      <div class="page-head-main">
        <div class="page-head-topline">
          <button class="link-back link-back--icon" type="button" (click)="backToList()" aria-label="Volver">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M15 18 9 12l6-6"></path>
            </svg>
          </button>
          <div class="order-id-wrap">
            <p class="eyebrow order-id-line">Pedido {{ current.order_id }}</p>
            <button
              type="button"
              class="order-id-copy"
              aria-label="Copiar ID del pedido"
              (click)="copyOrderId(current.order_id)"
            >
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <rect x="9" y="9" width="11" height="11" rx="2"></rect>
                <path d="M5 15V6a2 2 0 0 1 2-2h9"></path>
              </svg>
            </button>
            @if (copiedOrderId()) {
              <span class="copy-toast">Ã‚¡Copiado!</span>
            }
          </div>
        </div>
        <h1>{{ customerName(current) }}</h1>
        <p class="muted page-updated">Actualizado {{ current.updated_at | date: "short" }}</p>
        <div class="title-row title-row--meta">
          <span class="meta-dot-pill">{{ statusLabel(current.status) }}</span>
          <span class="meta-dot-pill meta-dot-pill--location">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M12 22s7-6 7-12a7 7 0 1 0-14 0c0 6 7 12 7 12z"></path>
              <circle cx="12" cy="10" r="2.5"></circle>
            </svg>
            {{ routeName(current) }}
          </span>
        </div>
      </div>
      <div class="status-actions">
        @if (phaseAction(current); as phase) {
          <button
            type="button"
            class="btn confirm-intelligent-btn"
            [class.primary]="phase.actionId !== 'confirm_items' || isConfirmExistencesReady(current)"
            [class.ghost]="phase.actionId === 'confirm_items' && !isConfirmExistencesReady(current)"
            [disabled]="phase.actionId === 'confirm_items' && current.items.length === 0"
            (click)="openActionModal(current)"
          >
            {{ phase.actionId === "confirm_items" ? confirmExistencesActionLabel(current) : phase.label }}
          </button>
        }
      </div>
    </header>

    @if (requiresPlannedPackages(current)) {
      <div class="sticky-banner">
        <div>
          <p class="eyebrow">Define paquetes planificados</p>
          <p class="muted">Necesitamos la cantidad esperada para habilitar acciones de logÃƒÂ­stica.</p>
        </div>
        <button type="button" class="btn primary" (click)="openPlannedPackages()">Definir paquetes</button>
      </div>
    }

    <section class="summary" aria-label="Resumen del pedido">
      <article class="summary-card summary-card--pieces">
        <span
          class="summary-progress-ring"
          aria-hidden="true"
          [style.--progress]="confirmedPiecesPercent(current)"
        >
          <span class="summary-progress-ring__value">
            {{ confirmedPiecesPercent(current) }}%
          </span>
        </span>
        <div>
          <p class="eyebrow">Piezas</p>
          <p class="summary-ratio">
            <strong class="summary-value">{{ confirmedPieces(current) }}</strong>
            <span>/ {{ totalPieces(current) }}</span>
          </p>
          <p class="summary-note" [class.summary-note--warning]="pendingPieces(current) > 0">
            {{ pendingPieces(current) }} pieza{{ pendingPieces(current) === 1 ? "" : "s" }} pendientes
          </p>
        </div>
      </article>

      <article class="summary-card summary-card--money">
        <p class="eyebrow">Total venta</p>
        <p class="summary-money">
          <span>MXN</span>
          <strong class="summary-value">{{ formatCurrency(totals().totalClienta) }}</strong>
        </p>
      </article>

      <article class="summary-card summary-card--money">
        <p class="eyebrow">Total clienta</p>
        <p class="summary-money">
          <span>MXN</span>
          <strong class="summary-value">{{ formatCurrency(totals().totalCost) }}</strong>
        </p>
      </article>

      <article class="summary-card summary-card--profit">
        <p class="eyebrow">Ganancia</p>
        <p class="summary-money summary-money--profit">
          <span>Ã¢â€ â€” MXN</span>
          <strong class="summary-value summary-value--profit">{{ formatCurrency(totals().ganancia) }}</strong>
        </p>
      </article>
    </section>

    <nav class="section-nav" aria-label="NavegaciÃƒÂ³n de secciones">
      <button type="button" (click)="scrollToSection('incidencias')">Incidencias</button>
      <button type="button" (click)="scrollToSection('productos')">Productos</button>
      <button type="button" (click)="scrollToSection('paquetes')">Paquetes</button>
      <button type="button" (click)="scrollToSection('bitacora')">BitÃƒ¡cora</button>
    </nav>

    <section class="panel" id="incidencias" #incidentsSection>
      <div class="panel-head">
        <h2>Incidencias</h2>
        <div class="panel-actions">
          <button type="button" class="btn ghost with-icon" (click)="openIncidentModal()">
            <span class="btn-icon" aria-hidden="true">+</span>
            Nueva incidencia
          </button>
          <button type="button" class="btn link" (click)="toggleResolved()">
            {{ showResolvedIncidents() ? "Ocultar" : "Ver" }} resueltas ({{ resolvedIncidents().length }})
          </button>
        </div>
      </div>
      <div class="incidents">
        @if (openIncidents().length === 0) {
          <p class="muted">Sin incidencias abiertas.</p>
        }
        @for (inc of openIncidents(); track inc.id) {
          <article
            class="incident-card"
            [class.high]="inc.severity === 'high'"
            [class.medium]="inc.severity === 'medium'"
            [class.low]="inc.severity === 'low'"
          >
            <div class="incident-main">
              <div class="incident-head">
                <p class="incident-title">{{ inc.title }}</p>
                <div class="incident-chips">
                  <span class="chip incident-chip incident-chip-type">{{ inc.type }}</span>
                  <span class="chip incident-chip incident-chip-severity">
                    {{ inc.severity === "high" ? "Alta" : inc.severity === "medium" ? "Media" : "Baja" }}
                  </span>
                </div>
              </div>
              <p class="incident-reason">{{ inc.reason }}</p>
              <p class="incident-meta">Asignado a {{ inc.assigneeId || "Sin asignar" }}</p>
              <p class="incident-meta">Creada {{ inc.createdAt | date: "short" }} Ã‚· {{ inc.createdBy }}</p>
              @if ((inc.evidenceUrls?.length || 0) > 0) {
                <div class="evidence">
                  @for (url of inc.evidenceUrls || []; track url) {
                    <a [href]="url" target="_blank" rel="noreferrer">Evidencia</a>
                  }
                </div>
              }
            </div>
            <div class="incident-actions">
              <button type="button" class="btn primary" (click)="openResolveModal(inc)">Resolver</button>
              <button type="button" class="btn ghost" (click)="openAssignModal(inc)">Asignar</button>
              <label class="btn ghost file-btn">
                <input type="file" accept="image/*" (change)="attachEvidence(inc, $event)" />
                {{ uploadingEvidence()[inc.id] ? "Subiendo..." : "Adjuntar foto" }}
              </label>
              <button type="button" class="btn link incident-link" (click)="scrollToTimeline()">Ver en bitÃƒ¡cora</button>
            </div>
          </article>
        }
      </div>
      @if (showResolvedIncidents() && resolvedIncidents().length > 0) {
        <div class="incidents resolved">
          @for (inc of resolvedIncidents(); track inc.id) {
            <article class="incident-card resolved">
              <div>
                <p class="eyebrow">{{ inc.title }} · {{ inc.type }}</p>
                <p class="muted">Resuelta {{ inc.resolvedAt | date: "short" }} · {{ inc.resolvedBy }}</p>
                @if (inc.resolutionNote) {
                  <p class="muted">{{ inc.resolutionNote }}</p>
                }
              </div>
            </article>
          }
        </div>
      }
    </section>

    <section class="panel" id="productos">
      <div class="panel-head">
        <h2>Productos</h2>
        <div class="panel-actions">
          <button type="button" class="btn primary with-icon" (click)="openAddItemModal()" [disabled]="!canEditItems(current)">
            <span class="btn-icon" aria-hidden="true">+</span>
            Agregar producto
          </button>
          <p class="muted">Escanea o cambia el estado por producto.</p>
        </div>
      </div>
      @if (current.items.length > 0) {
        <div class="products-toolbar" role="tablist" aria-label="Filtro de productos por stock">
          <button
            type="button"
            class="products-filter-btn"
            [class.active]="productStockFilter() === 'all'"
            (click)="setProductStockFilter('all')"
          >
            Todos ({{ totalItems(current) }})
          </button>
          <button
            type="button"
            class="products-filter-btn"
            [class.active]="productStockFilter() === 'insufficient'"
            [class.products-filter-btn--magnet]="shouldMagnetizeInsufficientTab(current)"
            [disabled]="insufficientItemsCount(current) === 0"
            (click)="setProductStockFilter('insufficient')"
          >
            Faltantes
            <span class="products-filter-count" [class.products-filter-count--alert]="insufficientItemsCount(current) > 0">
              ({{ insufficientItemsCount(current) }})
            </span>
          </button>
          @if (isConfirmItemsPhase(current) && hasPendingItems(current)) {
            <button
              type="button"
              class="products-batch-btn"
              (click)="confirmarTodoDisponible()"
              [disabled]="!canMagicConfirm(current)"
            >
              Marcar todo como disponible
            </button>
          }
        </div>
      }
      <div class="items order-item-grid">
        @for (item of filteredProductItems(current); track item.item_id) {
          <article
            class="order-item-card card-product"
            [id]="productCardId(item)"
            [class.has-incident]="itemHasOpenIncident(item.item_id)"
            [class.order-item-card--insufficient]="hasInsufficientStock(item)"
            [class.order-item-card--confirmado]="isConfirmedConfirmation(item)"
            [class.order-item-card--sin-stock]="isOutOfStockConfirmation(item)"
            [class.card-product--confirmed]="isConfirmedConfirmation(item)"
            [class.card-product--out-of-stock]="isOutOfStockConfirmation(item)"
            [class.card-product--alert]="hasInsufficientStock(item) && !isOutOfStockConfirmation(item)"
          >
            <div class="product-media">
              <img [src]="itemImage(item) || 'https://via.placeholder.com/240x200?text=Prod'" [alt]="item.title" />
            </div>

            <div class="product-main">
              <div class="product-title-stack">
                <h4 class="product-name">{{ item.title }}</h4>
                <span
                  class="origin-badge origin-badge--top"
                  [class.origin-badge--almacen]="item.source === 'inventario'"
                  [class.origin-badge--catalogo]="item.source === 'catalogo'"
                >
                  @if (item.source === "inventario") {
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <path d="M3 7h18v13H3z"></path>
                      <path d="M3 7 12 3l9 4"></path>
                    </svg>
                    <span>ALMACÃ‰N</span>
                  } @else if (item.source === "catalogo") {
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <path d="M4 5a2 2 0 0 1 2-2h12v17H6a2 2 0 0 0-2 2z"></path>
                      <path d="M18 3a2 2 0 0 1 2 2v17"></path>
                    </svg>
                    <span>CATÃLOGO</span>
                  } @else {
                    <span aria-hidden="true">E</span>
                    <span>EXTERNO</span>
                  }
                </span>
              </div>
              <p class="meta product-meta">Talla: {{ item.variant || "Sin talla" }} | Color: {{ item.color || "Sin color" }}</p>

              <div class="chips product-chips">
                <span class="chip chip--pieces">Piezas: {{ item.quantity }}</span>
                @if (isOutOfStockConfirmation(item)) {
                  <span class="chip chip--agotado">Agotado</span>
                }
                @if (hasPartialConfirmation(item)) {
                  <span class="chip chip--partial">Parcial: {{ confirmedQty(item) }} de {{ item.quantity }}</span>
                }
              </div>
            </div>

            <div class="product-side">
              <div class="price product-price">
                <span class="label">Precio clienta</span>
                <span class="value">{{ formatCurrency(item.price_clienta ?? item.price_public ?? null) || itemPriceLabel(item) }}</span>
              </div>
              @if (isConfirmItemsPhase(current)) {
                <div
                  class="product-actions"
                  [class.product-actions--resolved]="isConfirmedConfirmation(item)"
                  (click)="$event.stopPropagation()"
                >
                  @if (isConfirmedConfirmation(item)) {
                    <span class="product-confirmed-check" aria-label="Confirmado">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path d="m5 13 4 4L19 7"></path>
                      </svg>
                    </span>
                  } @else {
                    @if (hasInsufficientStock(item) && !isOutOfStockConfirmation(item)) {
                      <div class="qty-inline card-qty-inline" [attr.aria-label]="'Cantidad confirmable para ' + item.title">
                        <button type="button" class="qty-mini" [disabled]="isQuickConfirming(item)" (click)="decreaseCardConfirmedQty(item)">-</button>
                        <span class="qty-mini-value">{{ getCardDraftConfirmedQty(item) }} / {{ item.quantity }}</span>
                        <button type="button" class="qty-mini" [disabled]="isQuickConfirming(item)" (click)="increaseCardConfirmedQty(item)">+</button>
                      </div>
                    }
                    <button
                      type="button"
                      class="btn card-action-btn card-action-btn--confirm"
                      [disabled]="isQuickConfirming(item)"
                      (click)="confirmarItem(item)"
                    >
                      Confirmar
                    </button>
                    @if (!isOutOfStockConfirmation(item)) {
                      <button
                        type="button"
                        class="btn card-action-btn card-action-btn--out"
                        [class.active]="isOutOfStockConfirmation(item)"
                        [disabled]="isQuickConfirming(item)"
                        (click)="marcarAgotado(item)"
                      >
                        Agotar
                      </button>
                    }
                  }
                </div>
              }
              @if (allowedCapabilities(current, userRole()).canRegisterReception) {
                <button type="button" class="btn ghost" (click)="receiveItem(current, item)">Registrar recepciÃƒÂ³n/QA</button>
              }
              @if (allowedCapabilities(current, userRole()).canPack) {
                <button type="button" class="btn ghost" (click)="markPacked(current, item)">Empacar</button>
              }
              <div class="card-delete-wrap">
                <button
                  type="button"
                  class="btn btn--danger btn--icon-delete"
                  (click)="removeItem(current, item)"
                  aria-label="Quitar producto"
                  [disabled]="!canEditItems(current)"
                >
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="M3 6h18"></path>
                    <path d="M8 6V4h8v2"></path>
                    <path d="M7 6l1 14h8l1-14"></path>
                  </svg>
                </button>
              </div>
            </div>
            @if (hasInsufficientStock(item)) {
              <span class="stock-warning-micro">Ã¢Å¡Â Ã¯Â¸Â Solo {{ availableStock(item) }} disponibles</span>
            }
          </article>
        }
        @if (current.items.length === 0) {
          <p class="muted">AÃƒÂºn no hay productos en este pedido.</p>
        }
      </div>
    </section>

    @if (allowedCapabilities(current, userRole()).canCreatePackages) {
      <section class="panel package-shell" id="paquetes" #packagesSection>
        <div class="panel-head">
          <h2>Paquetes</h2>
          <div class="panel-actions">
            <button
              type="button"
              class="btn primary with-icon"
              [disabled]="requiresPlannedPackages(current)"
              [attr.title]="requiresPlannedPackages(current) ? 'Define paquetes planificados para continuar' : null"
              (click)="createPackage(current)"
            >
              <span class="btn-icon" aria-hidden="true">+</span>
              Crear paquete
            </button>
            @if (requiresPlannedPackages(current)) {
              <span class="muted small">Define paquetes planificados</span>
            }
          </div>
        </div>

        <div class="packages">
          @for (pkg of current.packages; track pkg.package_id) {
            <article class="package">
              <div class="package-top">
                <div>
                  <p class="eyebrow">{{ packageDisplayLabel(current, pkg) }}</p>
                  <p class="muted">{{ pkg.item_ids.length }} productos Ã‚· {{ pkg.state }}</p>
                </div>
                <span class="chip">{{ qrPlaceholder(current, pkg) }}</span>
              </div>
              @if (debugMode()) {
                <div class="qr-block">
                  <p class="muted">QR data</p>
                  <code>{{ packageCode(current, pkg) }}</code>
                </div>
              }
              @if (allowedCapabilities(current, userRole()).canPrintLabels) {
                <button type="button" class="btn ghost" (click)="printLabel(current, pkg)">Imprimir etiqueta</button>
              }
              @if (allowedCapabilities(current, userRole()).canDeliverByPackage) {
                <button type="button" class="btn primary" (click)="deliverPackage(current, pkg)">Registrar entrega</button>
              }
              @if (allowedCapabilities(current, userRole()).canAssignItemsToPackages) {
                <button type="button" class="btn ghost" (click)="closePackage(current, pkg)">Cerrar paquete</button>
              }
            </article>
          }

          @if (current.packages.length === 0) {
            <p class="muted package-empty-note">Sin paquetes todavÃƒÂ­a. Genera uno al terminar de empacar.</p>
          }
        </div>

        @if (allowedCapabilities(current, userRole()).canAssignItemsToPackages && current.packages.length > 0) {
          <div class="assignment">
            <div class="panel-actions">
              <select class="input" [(ngModel)]="selectedPackageId">
                <option [ngValue]="null">Selecciona un paquete</option>
                @for (pkg of current.packages; track pkg.package_id) {
                  <option [ngValue]="pkg.package_id">{{ packageDisplayLabel(current, pkg) }}</option>
                }
              </select>
              <button type="button" class="btn ghost" (click)="autoDistribute(current)">Auto-distribuir</button>
            </div>
            @if (selectedPackageId()) {
              <div class="items">
                @for (item of current.items; track item.item_id) {
                  <label class="assign-row">
                    <input
                      type="checkbox"
                      [checked]="isItemAssigned(current, selectedPackageId(), item.item_id)"
                      (change)="toggleItemAssignment(current, selectedPackageId()!, item, $any($event.target).checked)"
                    />
                    <span>{{ item.title }} Ã‚· {{ item.quantity }} pza</span>
                  </label>
                }
              </div>
            }
          </div>
        }
      </section>
    } @else {
      <section class="panel locked package-shell" id="paquetes" #packagesSection>
        <div class="panel-head">
          <h2>Paquetes</h2>
        </div>
        <p class="muted package-empty-note">Los paquetes se habilitan al recibir/QA o empaque.</p>
      </section>
    }

    <section class="panel" id="bitacora" #timelineSection>
      <div class="panel-head">
        <h2>BitÃƒ¡cora</h2>
      </div>
      @if (events().length > 0) {
        <ol class="timeline">
          @for (event of events(); track event.id) {
            <li class="timeline-item">
              <p class="eyebrow timeline-date">{{ event.createdAt | date: "short" }} Ã‚· {{ relativeTime(event.createdAt) }}</p>
              <p>{{ event.message }}</p>
              <p class="muted">{{ eventActor(event) }}</p>
            </li>
          }
        </ol>
        @if (eventsHasMore()) {
          <button type="button" class="btn ghost with-icon" (click)="loadEvents()" [disabled]="eventsLoading()">
            <span class="btn-icon" aria-hidden="true">Ã¢â€ Â»</span>
            {{ eventsLoading() ? "Cargando..." : "Cargar mÃƒ¡s" }}
          </button>
        }
      } @else {
        <ol class="timeline">
          @for (event of current.timeline; track event.id) {
            <li class="timeline-item">
              <p class="eyebrow timeline-date">{{ event.created_at | date: "short" }} Ã‚· {{ relativeTime(event.created_at) }}</p>
              <p>{{ event.label }}</p>
              <p class="muted">{{ eventActor(event) }}</p>
            </li>
          }
        </ol>
      }
    </section>

    <div class="sticky-action-bar" [class.show]="showStickyFooter()">
      <div class="sticky-action-meta">
        <p class="sticky-name">{{ customerName(current) }}</p>
        <p class="sticky-total">Total: {{ formatCurrency(totals().totalClienta) }}</p>
      </div>
      <button
        type="button"
        class="btn sticky-confirm-btn confirm-intelligent-btn"
        [class.primary]="isConfirmExistencesReady(current)"
        [class.ghost]="!isConfirmExistencesReady(current)"
        [disabled]="!isConfirmItemsPhase(current) || current.items.length === 0"
        (click)="openActionModal(current)"
      >
        {{ confirmExistencesActionLabel(current) }}
      </button>
    </div>
    @if (shouldShowStockFab(current)) {
      <button type="button" class="stock-fab" (click)="scrollToFirstInsufficientProduct(current)">
        {{ insufficientItemsCount(current) }} errores
      </button>
    }
  </section>

  @if (actionModalOpen() && actionContext()) {
    <div class="sheet-backdrop" (click)="closeActionModal()">
      <div
        class="sheet"
        role="dialog"
        aria-modal="true"
        [class.sheet-confirm-items]="actionContext()?.actionId === 'confirm_items'"
        [attr.aria-labelledby]="actionContext()?.actionId === 'confirm_items' ? 'confirm-items-title' : 'action-modal-title'"
        [attr.aria-describedby]="actionContext()?.actionId === 'confirm_items' ? 'confirm-items-description' : null"
        (click)="$event.stopPropagation()"
      >
        <div class="sheet-handle" aria-hidden="true"></div>
        @if (actionContext()?.actionId !== "confirm_items") {
          <h2 id="action-modal-title">{{ actionContext()?.label }}</h2>
        }
        @if (actionError()) {
          <div class="sheet-warning">
            <p class="eyebrow">AtenciÃƒÂ³n</p>
            <p>{{ actionError() }}</p>
          </div>
        }

        @if (actionContext()?.actionId === "confirm_items") {
          <section class="confirm-shell" id="confirm-items-description">
            <header class="confirm-header" [class.confirm-header-resolved]="allItemsResolved(current)">
              <div class="confirm-header-main">
                <p class="eyebrow">Control de inventario</p>
                <h2 id="confirm-items-title">Confirmar existencias</h2>
                @if (!allItemsResolved(current)) {
                  <p class="muted">Valida cada pieza para poder cerrar esta etapa.</p>
                }
              </div>
              @if (allItemsResolved(current)) {
                <div class="confirm-header-state" aria-label="Resuelto">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="m5 13 4 4L19 7"></path>
                  </svg>
                </div>
              }

            </header>

            @if (current.items.length > 0) {
              <div class="confirm-kpis">
                <article class="confirm-kpi kpi-confirmed">
                  <p class="kpi-label">Confirmadas</p>
                  <p class="kpi-value">{{ confirmedPieces(current) }}</p>
                </article>
                <article class="confirm-kpi kpi-out">
                  <p class="kpi-label">Sin stock</p>
                  <p class="kpi-value">{{ outOfStockPieces(current) }}</p>
                </article>
                <article class="confirm-kpi kpi-pending">
                  <p class="kpi-label">Pendientes</p>
                  <p class="kpi-value">{{ pendingPieces(current) }}</p>
                </article>
              </div>
            }

          @if (current.items.length === 0) {
            <div class="sheet-warning">
              <p class="eyebrow">Bloqueado</p>
              <p>No hay productos en el pedido.</p>
            </div>
          }
          @if (current.items.length > 0) {
            <div class="confirm-summary">
              <div class="confirm-progress" role="progressbar" [attr.aria-valuenow]="resolvedItems(current)" aria-valuemin="0" [attr.aria-valuemax]="totalItems(current)">
                <span class="confirm-progress-bar" [style.width.%]="totalItems(current) > 0 ? (resolvedItems(current) * 100) / totalItems(current) : 0"></span>
              </div>
            </div>
          }
          <div class="confirm-items-list">
            @for (group of groupedItemsBySupplier(current); track group.supplierId) {
              <div class="supplier-group">
                <div class="supplier-head" [class.resolved]="groupUnresolvedCount(group.items) === 0">
                  <div class="supplier-meta">
                    <p class="supplier-title">{{ group.supplierName }}</p>
                    <div class="supplier-stats">
                      @if (groupUnresolvedCount(group.items) === 0) {
                        <span class="stat-chip success">Resuelto</span>
                      } @else {
                        <span class="stat-chip pending">Pendientes {{ groupUnresolvedCount(group.items) }}</span>
                      }
                      <span class="stat-chip">Items {{ group.items.length }}</span>
                    </div>
                  </div>
                </div>
                <div class="items">
                  @for (item of group.items; track item.item_id) {
                    <article
                      class="item-card compact"
                      [class.resolved]="item.confirmation_state && item.confirmation_state !== 'pending'"
                      [class.state-confirmed]="item.confirmation_state === 'confirmed'"
                      [class.state-partial]="hasPartialConfirmation(item)"
                      [class.state-out]="item.confirmation_state === 'out_of_stock'"
                    >
                      <div class="item-thumb">
                        @if (itemImage(item); as imageUrl) {
                          <img [src]="imageUrl" [alt]="item.title" />
                        } @else {
                          <div class="photo-placeholder photo-placeholder-sm" aria-hidden="true">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M4 7h4l2-2h4l2 2h4v12H4z"></path>
                              <circle cx="12" cy="13" r="3"></circle>
                            </svg>
                          </div>
                        }
                      </div>
                      <div class="item-info">
                        <div class="item-title-row">
                          <p class="item-title">{{ item.title }}</p>
                          @if (item.confirmation_state === "confirmed" && !hasPartialConfirmation(item)) {
                            <span class="item-confirm-icon" aria-label="Confirmado">
                              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <path d="m5 13 4 4L19 7"></path>
                              </svg>
                            </span>
                          }
                        </div>
                        <p class="muted">{{ item.variant || "Variante" }} Ã‚· {{ item.color || "Color" }}</p>
                        <span class="item-chip source" [class.catalog]="item.source === 'catalogo'" [class.inventory]="item.source === 'inventario'">
                          {{ item.source === "catalogo" ? "CatÃƒ¡logo" : "Inventario" }}
                        </span>
                      </div>
                      <div class="item-actions">
                        <p class="qty-caption">Cantidad disponible</p>
                        <div class="qty-inline" [attr.aria-label]="'Cantidad disponible para ' + item.title">
                          <button type="button" class="qty-mini" (click)="decreaseDraftConfirmedQty(item)" [disabled]="current.items.length === 0">-</button>
                          <span class="qty-mini-value">{{ getDraftConfirmedQty(item) }}/{{ item.quantity }}</span>
                          <button type="button" class="qty-mini" (click)="increaseDraftConfirmedQty(item)" [disabled]="current.items.length === 0">+</button>
                        </div>
                        <button
                          type="button"
                          class="btn ghost action-confirm"
                          [class.active]="item.confirmation_state === 'confirmed'"
                          [attr.aria-pressed]="item.confirmation_state === 'confirmed'"
                          (click)="confirmItem(current, item)"
                          [disabled]="current.items.length === 0"
                        >
                          <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path d="m5 13 4 4L19 7"></path>
                          </svg>
                          Confirmar
                        </button>
                        <button
                          type="button"
                          class="btn ghost action-out"
                          [class.active]="item.confirmation_state === 'out_of_stock'"
                          [attr.aria-pressed]="item.confirmation_state === 'out_of_stock'"
                          (click)="markOutOfStock(current, item)"
                          [disabled]="current.items.length === 0"
                        >
                          <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                            <path d="M12 9v4"></path>
                            <path d="M12 17h.01"></path>
                          </svg>
                          Sin stock
                        </button>
                      </div>
                    </article>
                  }
                </div>
              </div>
            }
          </div>
          @if (current.items.length > 0) {
            <div class="confirm-footer">
              <div class="confirm-footer-text">
                <p class="confirm-footer-title">
                  {{ resolvedItems(current) }}/{{ totalItems(current) }} resueltos
                </p>
                <p class="muted small">
                  Confirmadas {{ confirmedPieces(current) }} Ã‚· Sin stock {{ outOfStockPieces(current) }} Ã‚· Pendientes {{ pendingPieces(current) }}
                </p>
              </div>
              <button type="button" class="btn ghost" (click)="closeActionModal()">Cancelar</button>
              <button
                type="button"
                class="btn primary confirm-submit-btn"
                [disabled]="!allItemsResolved(current) || actionSaving()"
                (click)="confirmExistences(current)"
              >
                {{ actionSaving() ? "Guardando..." : "Confirmar existencias" }}
              </button>
            </div>
          }
          </section>
        }

        @if (actionContext()?.actionId === "pack") {
          <div class="items">
            @for (item of current.items; track item.item_id) {
              <article class="item-card compact">
                <div class="item-info">
                  <p class="item-title">{{ item.title }}</p>
                  <p class="muted">{{ item.variant || "Variante" }} Ã‚· {{ item.color || "Color" }}</p>
                </div>
                <div class="item-actions">
                  <button type="button" class="btn ghost" (click)="receiveItem(current, item)">Recibido/QA</button>
                  <button type="button" class="btn ghost" (click)="markMissing(current, item)">Faltante</button>
                  <button type="button" class="btn ghost" (click)="markDamaged(current, item)">DaÃƒÂ±ado</button>
                  <button type="button" class="btn ghost" (click)="markPacked(current, item)">Empacar</button>
                </div>
              </article>
            }
          </div>
        }

        @if (actionContext()?.actionId === "dispatch") {
          <p class="muted">Revisa precondiciones para preparar salida.</p>
          <ul class="checklist">
            <li [class.bad]="!canDispatch(current)">Paquetes cerrados = planificados y sin productos sin asignar.</li>
          </ul>
          <button type="button" class="btn primary" (click)="dispatchOrder(current)">Preparar salida</button>
        }

        @if (actionContext()?.actionId === "deliver") {
          <div class="packages">
            @for (pkg of current.packages; track pkg.package_id) {
              <article class="package">
                <div class="package-top">
                  <div>
                    <p class="eyebrow">{{ packageDisplayLabel(current, pkg) }}</p>
                    <p class="muted">{{ pkg.item_ids.length }} productos Ã‚· {{ pkg.state }}</p>
                  </div>
                </div>
                <button type="button" class="btn primary" (click)="deliverPackage(current, pkg)">Registrar entrega</button>
              </article>
            }
          </div>
        }

        @if (actionContext()?.actionId === "register_payment") {
          <p class="muted">Registra el pago del pedido.</p>
          <button type="button" class="btn primary" (click)="registerPayment(current)">Registrar pago/conciliar</button>
        }

        @if (current.status === "en_ruta" && !lateChangeApproved()) {
          <button type="button" class="btn ghost" (click)="requestLateChange(current)">Solicitar cambio tardÃƒÂ­o</button>
        }

        @if (actionContext()?.actionId !== "confirm_items") {
          <button type="button" class="btn ghost" (click)="closeActionModal()">Cerrar</button>
        }
      </div>
    </div>
  }

  @if (plannedModalOpen()) {
    <div class="sheet-backdrop" (click)="closePlannedPackages()">
      <div
        class="sheet"
        role="dialog"
        aria-modal="true"
        aria-labelledby="planned-packages-title"
        aria-describedby="planned-packages-description"
        (click)="$event.stopPropagation()"
      >
        <div class="sheet-handle" aria-hidden="true"></div>
        <h2 id="planned-packages-title">Ã‚¿CuÃƒ¡ntos paquetes esperas?</h2>
        <p class="muted" id="planned-packages-description">Define la cantidad para habilitar logÃƒÂ­stica.</p>
        <div class="sheet-field">
          <label>Paquetes planificados</label>
          <input type="number" min="1" class="input" [(ngModel)]="plannedPackagesInput" />
        </div>
        <div class="sheet-actions">
          <button type="button" class="btn primary" (click)="savePlannedPackages()">Guardar</button>
          <button type="button" class="btn ghost" (click)="closePlannedPackages()">Ahora no</button>
        </div>
      </div>
    </div>
  }

  @if (incidentModalOpen()) {
    <div class="sheet-backdrop" (click)="closeIncidentModal()">
      <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="incident-modal-title" (click)="$event.stopPropagation()">
        <div class="sheet-handle" aria-hidden="true"></div>
        <h2 id="incident-modal-title">Nueva incidencia</h2>
        <div class="sheet-field">
          <label>TÃƒÂ­tulo</label>
          <input class="input" type="text" [(ngModel)]="incidentTitle" />
        </div>
        <div class="sheet-field">
          <label>Tipo</label>
          <input class="input" type="text" [(ngModel)]="incidentType" />
        </div>
        <div class="sheet-field">
          <label>Severidad</label>
          <select class="input" [(ngModel)]="incidentSeverity">
            <option value="low">Baja</option>
            <option value="medium">Media</option>
            <option value="high">Alta</option>
          </select>
        </div>
        <div class="sheet-field">
          <label>Asignar a</label>
          <input class="input" type="text" [(ngModel)]="incidentAssignee" list="assigneeOptions" />
          <datalist id="assigneeOptions">
            @for (name of assigneeOptions(); track name) {
              <option [value]="name"></option>
            }
          </datalist>
        </div>
        <div class="sheet-field">
          <label>Motivo</label>
          <textarea class="input" rows="3" [(ngModel)]="incidentReason"></textarea>
        </div>
        <div class="sheet-actions">
          <button type="button" class="btn primary" [disabled]="incidentSaving()" (click)="createIncident()">Guardar</button>
          <button type="button" class="btn ghost" (click)="closeIncidentModal()">Cancelar</button>
        </div>
      </div>
    </div>
  }

  @if (resolveModalOpen()) {
    <div class="sheet-backdrop" (click)="closeResolveModal()">
      <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="resolve-modal-title" (click)="$event.stopPropagation()">
        <div class="sheet-handle" aria-hidden="true"></div>
        <h2 id="resolve-modal-title">Resolver incidencia</h2>
        <div class="sheet-field">
          <label>Nota de resoluciÃƒÂ³n</label>
          <textarea class="input" rows="3" [(ngModel)]="resolveNote"></textarea>
        </div>
        <div class="sheet-actions">
          <button type="button" class="btn primary" (click)="confirmResolve()">Confirmar</button>
          <button type="button" class="btn ghost" (click)="closeResolveModal()">Cancelar</button>
        </div>
      </div>
    </div>
  }

  @if (addItemModalOpen()) {
    <div class="sheet-backdrop" (click)="closeAddItemModal()">
      <div class="sheet full" role="dialog" aria-modal="true" aria-labelledby="add-item-modal-title" (click)="$event.stopPropagation()">
        <div class="sheet-header">
          <div class="sheet-handle" aria-hidden="true"></div>
          <h2 id="add-item-modal-title">Agregar producto</h2>
          <button type="button" class="btn ghost" (click)="closeAddItemModal()">Cerrar</button>
        </div>
        <div class="sheet-body">
          <div class="add-item">
          <div class="section-row">
            <div class="pill source-toggle">
              <label>
                <input type="radio" name="source" value="catalogo" [(ngModel)]="newItemSource" [disabled]="!canEditItems(current)" />
                CatÃƒ¡logo
              </label>
              <label>
                <input type="radio" name="source" value="inventario" [(ngModel)]="newItemSource" [disabled]="!canEditItems(current)" />
                Inventario
              </label>
            </div>
          </div>
          <div class="product-search">
            <div class="field">
              <label>Buscar producto</label>
              <input
                class="input"
                type="text"
                placeholder="Nombre, variante o color"
                [(ngModel)]="newItemSearch"
              (focus)="showProductList.set(true)"
              (keydown.escape)="showProductList.set(false)"
                [disabled]="!canEditItems(current)"
              />
            </div>
            @if (showProductList() && (inventorySuggestions().length > 0 || catalogSuggestions().length > 0)) {
              <div class="listbox" role="listbox" aria-label="Resultados de productos">
                @for (s of inventorySuggestions(); track s.inventory_id) {
                  <button type="button" role="option" class="listbox-option" [attr.aria-label]="'Inventario: ' + s.title" (mousedown)="$event.preventDefault(); beginProductPick(); pickInventory(s)" (touchstart)="$event.preventDefault(); beginProductPick(); pickInventory(s)" (click)="beginProductPick(); pickInventory(s)">
                    @if (s.image_urls[0]) {
                      <img class="listbox-thumb" [src]="s.image_urls[0]" alt="" />
                    } @else {
                      <div class="photo-placeholder photo-placeholder-sm" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M4 7h4l2-2h4l2 2h4v12H4z"></path>
                          <circle cx="12" cy="13" r="3"></circle>
                        </svg>
                      </div>
                    }
                    <div>
                      <div class="card-title">{{ s.title }}</div>
                      <div class="card-meta">{{ s.variant_name || s.size_label || "Variante" }} Ã‚· {{ s.color_name || "Color" }}</div>
                    </div>
                    <span class="card-tag inv">Inventario Ã‚· {{ s.quantity_on_hand }} pzas</span>
                  </button>
                }
                @for (c of catalogSuggestions(); track c.doc.normalized_id) {
                  <button type="button" role="option" class="listbox-option" [attr.aria-label]="'CatÃƒ¡logo: ' + c.doc.listing.title" (mousedown)="$event.preventDefault(); beginProductPick(); pickCatalog(c.doc, c.variant, c.color)" (touchstart)="$event.preventDefault(); beginProductPick(); pickCatalog(c.doc, c.variant, c.color)" (click)="beginProductPick(); pickCatalog(c.doc, c.variant, c.color)">
                    @if (c.image) {
                      <img class="listbox-thumb" [src]="c.image" alt="" />
                    } @else {
                      <div class="photo-placeholder photo-placeholder-sm" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M4 7h4l2-2h4l2 2h4v12H4z"></path>
                          <circle cx="12" cy="13" r="3"></circle>
                        </svg>
                      </div>
                    }
                    <div>
                      <div class="card-title">{{ c.doc.listing.title }}</div>
                      <div class="card-meta">{{ c.doc.listing.category_hint || "Sin categorÃƒÂ­a" }}</div>
                    </div>
                    <span class="card-tag cat">{{ c.variant.variant_name || '-' }} Ã‚· {{ c.color || 'Color' }}</span>
                  </button>
                }
              </div>
            }
          </div>
          @if (selectedPreview(); as preview) {
            <div class="preview">
              @if (preview.image) {
                <img [src]="preview.image" alt="" />
              } @else {
                <div class="photo-placeholder photo-placeholder-md" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 7h4l2-2h4l2 2h4v12H4z"></path>
                    <circle cx="12" cy="13" r="3"></circle>
                  </svg>
                </div>
              }
              <div>
                <p class="preview-title">{{ preview.title }}</p>
                <p class="preview-meta">{{ preview.variant }} Ã‚· {{ preview.color }}</p>
                @if (!selectedPreviewHasColorImage()) {
                  <span class="color-chip">Color: {{ preview.color }}</span>
                }
                <span class="preview-tag">{{ preview.source }}</span>
              </div>
            </div>
          }
          <div class="field">
            <label>Producto</label>
            <input
              class="input"
              type="text"
              [(ngModel)]="newItemTitle"
              [readonly]="lockItemFields()"
              [disabled]="!selectedPreview() || !canEditItems(current)"
            />
          </div>
          @if (catalogVariantOptions().length > 0) {
            <div class="field">
              <label>Variante / talla</label>
              <select
                class="input"
                [ngModel]="newItemVariant()"
                (ngModelChange)="onVariantChange($event)"
                [disabled]="!selectedPreview() || !canEditItems(current)"
              >
                @for (v of catalogVariantOptions(); track v) {
                  <option [value]="v">{{ v }}</option>
                }
              </select>
            </div>
          } @else {
            <div class="field">
              <label>Variante / talla</label>
              <input
                class="input"
                type="text"
                [(ngModel)]="newItemVariant"
                [readonly]="lockItemFields()"
                [disabled]="!selectedPreview() || !canEditItems(current)"
              />
            </div>
          }
          @if (catalogColorOptions().length > 0) {
            <div class="field">
              <label>Color</label>
              <select
                class="input"
                [ngModel]="newItemColor()"
                (ngModelChange)="onColorChange($event)"
                [disabled]="!selectedPreview() || !canEditItems(current)"
              >
                @for (c of catalogColorOptions(); track c) {
                  <option [value]="c">{{ c }}</option>
                }
              </select>
            </div>
          } @else {
            <div class="field">
              <label>Color</label>
              <input
                class="input"
                type="text"
                [(ngModel)]="newItemColor"
                [readonly]="lockItemFields()"
                [disabled]="!selectedPreview() || !canEditItems(current)"
              />
            </div>
          }
          <div class="field">
            <label>Cantidad</label>
            <input
              class="input"
              type="number"
              min="1"
              [(ngModel)]="newItemQty"
              [disabled]="!selectedPreview() || !canEditItems(current)"
            />
          </div>
          <div class="field">
            <label>Precio final</label>
            <div class="money" [class.money-invalid]="priceRuleInvalid()">
              <span>MXN</span>
              <input
                class="input"
                type="text"
                [value]="priceDisplayValue('final')"
                (focus)="onPriceInputFocus('final')"
                (input)="onPriceInputChange('final', $any($event.target).value)"
                (blur)="onPriceInputBlur('final')"
                [disabled]="!selectedPreview() || !canEditItems(current)"
              />
            </div>
          </div>
          <div class="field">
            <label>Precio clienta</label>
            <div class="money money-readonly" [class.money-invalid]="priceRuleInvalid()">
              <span>MXN</span>
              <input
                class="input"
                type="text"
                [value]="priceDisplayValue('clienta')"
                readonly
                disabled
              />
            </div>
          </div>
          <div class="field">
            <label>Precio costo</label>
            <div class="money money-readonly">
              <span>MXN</span>
              <input
                class="input"
                type="text"
                [value]="priceDisplayValue('costo')"
                readonly
                disabled
              />
            </div>
          </div>
        </div>
        </div>
        <div class="sheet-footer">
          <button type="button" class="btn primary" (click)="addItem(current)" [disabled]="!selectedPreview() || !canEditItems(current)">
            AÃƒÂ±adir al pedido
          </button>
          <button type="button" class="btn danger" (click)="closeAddItemModal()">Cancelar</button>
        </div>
      </div>
    </div>
  }

  @if (assignModalOpen()) {
    <div class="sheet-backdrop" (click)="closeAssignModal()">
      <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="assign-modal-title" (click)="$event.stopPropagation()">
        <div class="sheet-handle" aria-hidden="true"></div>
        <h2 id="assign-modal-title">Asignar incidencia</h2>
        <div class="sheet-field">
          <label>Asignar a</label>
          <input class="input" type="text" [(ngModel)]="incidentAssignee" list="assigneeOptions" />
          <datalist id="assigneeOptions">
            @for (name of assigneeOptions(); track name) {
              <option [value]="name"></option>
            }
          </datalist>
        </div>
        <div class="sheet-actions">
          <button type="button" class="btn primary" (click)="confirmAssign()">Confirmar</button>
          <button type="button" class="btn ghost" (click)="closeAssignModal()">Cancelar</button>
        </div>
      </div>
    </div>
  }
} @else {
  <section class="page">
    <p class="muted">No encontramos este pedido.</p>
    <button type="button" class="btn" routerLink="/main/pedidos">Volver a la lista</button>
  </section>
}


