<section class="inventory-page">
  <header class="page-header">
    <div>
      <h1>Inventario interno</h1>
      <p>
        Registra devoluciones o piezas sueltas que se quedan contigo. Aqui puedes crear, editar, ajustar
        cantidad y eliminar registros rapido.
      </p>
    </div>

    <button type="button" class="btn btn-secondary" (click)="reload()" [disabled]="loading()">
      <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <path d="M21 12a9 9 0 1 1-2.64-6.36"></path>
        <path d="M21 3v6h-6"></path>
      </svg>
      {{ loading() ? "Actualizando..." : "Actualizar" }}
    </button>
  </header>

  <section class="stats-grid" aria-label="Resumen de inventario">
    <button type="button" class="stat-card stat-card-featured" (click)="applyQuickFilter('all')">
      <div class="stat-head">
        <p>Inversion total</p>
        <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M12 1v22"></path>
          <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7H14.5a3.5 3.5 0 0 1 0 7H6"></path>
        </svg>
      </div>
      <strong>{{ formatMoney(totalInvestment()) }}</strong>
      <small>Costo unitario x existencias</small>
    </button>

    <button type="button" class="stat-card" (click)="applyQuickFilter('sold_out')" [class.stat-card-active]="stockFilter() === 'sold_out'">
      <div class="stat-head">
        <p>Agotados</p>
        <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
          <path d="M12 9v4"></path>
          <path d="M12 17h.01"></path>
        </svg>
      </div>
      <strong>{{ formatCount(soldOutCount()) }}</strong>
    </button>

    <button type="button" class="stat-card" (click)="applyQuickFilter('low')" [class.stat-card-active]="stockFilter() === 'low'">
      <div class="stat-head">
        <p>Pocas piezas</p>
        <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M21 12a9 9 0 1 1-2.64-6.36"></path>
          <path d="M21 3v6h-6"></path>
        </svg>
      </div>
      <strong>{{ formatCount(lowStockCount()) }}</strong>
    </button>

    <button type="button" class="stat-card" (click)="applyQuickFilter('all')" [class.stat-card-active]="stockFilter() === 'all'">
      <div class="stat-head">
        <p>Piezas totales</p>
        <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
        </svg>
      </div>
      <strong>{{ formatCount(totalUnits()) }}</strong>
    </button>

    <button type="button" class="stat-card" (click)="applyQuickFilter('all')" [class.stat-card-active]="stockFilter() === 'all'">
      <div class="stat-head">
        <p>Items</p>
        <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M3 7h18"></path>
          <path d="M5 7v11a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7"></path>
          <path d="M9 7V5a3 3 0 0 1 6 0v2"></path>
        </svg>
      </div>
      <strong>{{ formatCount(rows().length) }}</strong>
    </button>
  </section>

  @if (error()) {
    <div class="alert alert-error" role="alert">{{ error() }}</div>
  }

  @if (success()) {
    <div class="alert alert-success" role="status">{{ success() }}</div>
  }

  <section class="panel filters-panel">
    <div class="filters-head">
      <h2>Filtros</h2>
      @if (hasActiveFilters()) {
        <small>Activos</small>
      } @else {
        <small>Sin filtros activos</small>
      }
    </div>

    <label class="field" for="inventory-search">
      <span>Buscar item</span>
      <input
        id="inventory-search"
        type="text"
        class="input"
        [ngModel]="searchTerm()"
        (ngModelChange)="searchTerm.set($event)"
        placeholder="Nombre, categoria, color, proveedor o nota"
      />
    </label>

    <div class="filters-row">
      <select class="input" [ngModel]="stockFilter()" (ngModelChange)="onStockFilterChange($event)" aria-label="Filtro de stock">
        <option value="all">Todo el inventario</option>
        <option value="low">Pocas piezas (1 a 3)</option>
        <option value="sold_out">Solo agotados</option>
      </select>

      <button
        type="button"
        class="btn btn-outline"
        (click)="clearFilters()"
        [disabled]="!hasActiveFilters()"
      >
        Limpiar filtros
      </button>
    </div>
  </section>

  <section class="content-grid">
    <article class="panel form-panel">
      <div class="form-header">
        <h2>{{ editingId() ? "Editar item" : "Nuevo item" }}</h2>
        @if (editingId()) {
          <button type="button" class="btn btn-ghost" (click)="startCreate()">Nuevo</button>
        }
      </div>

      <form class="form-grid" (submit)="save(); $event.preventDefault()">
        <label class="field">
          <span>Nombre del producto *</span>
          <input
            type="text"
            class="input"
            [(ngModel)]="draft.title"
            name="title"
            placeholder="Ejemplo: Cobertor polar"
            required
          />
        </label>

        <label class="field category-field">
          <span>Categoria *</span>
          <div class="category-input-row">
            <input
              type="text"
              class="input"
              [ngModel]="categoryQuery()"
              (ngModelChange)="onCategoryInputChange($event)"
              (focus)="onCategoryInputFocus()"
              (blur)="onCategoryInputBlur()"
              name="category_query"
              autocomplete="off"
              placeholder="Escribe para buscar"
            />
          </div>

          @if (categoryConfirmed()) {
            <small class="category-confirmed">Categoria seleccionada: {{ draft.category_hint }}</small>
          }

          <div class="category-status">
            @if (categoryConfirmed() && selectedCategoryId()) {
              <span class="status-chip chip-ok">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <path d="m5 13 4 4L19 7"></path>
                </svg>
                <span>Nivel final seleccionado</span>
              </span>
            } @else {
              <span class="status-chip chip-pending">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <path d="M12 9v4"></path>
                  <path d="M12 17h.01"></path>
                  <path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                </svg>
                <span>Selecciona una categoria</span>
              </span>
            }
          </div>

          @if (categoryDropdownOpen()) {
            <div class="category-dropdown" role="listbox">
              @if (filteredCategoryOptions().length === 0) {
                <p class="category-empty">Sin coincidencias (prueba con mas texto).</p>
              } @else {
                @for (category of filteredCategoryOptions(); track category.id) {
                  <button
                    type="button"
                    class="category-option"
                    [class.category-option-parent]="hasCategoryChildren(category.id)"
                    (mousedown)="$event.preventDefault()"
                    (click)="selectCategory(category)"
                  >
                    {{ category.fullPath }}
                    @if (hasCategoryChildren(category.id)) {
                      <small> (categoria padre, selecciona una final)</small>
                    }
                  </button>
                }
              }
            </div>
          }
        </label>

        <div class="form-columns">
          <label class="field">
            <span>Proveedor</span>
            <select class="input" [(ngModel)]="draft.supplier_id" name="supplier_id">
              <option value="">Sin proveedor</option>
              @for (supplier of supplierOptions(); track supplier.supplier_id) {
                <option [value]="supplier.supplier_id">{{ supplier.display_name }}</option>
              }
            </select>
          </label>

          <label class="field">
            <span>Cantidad disponible *</span>
            <input
              type="number"
              min="0"
              class="input"
              [(ngModel)]="draft.quantity_on_hand"
              name="quantity_on_hand"
              required
            />
          </label>
        </div>

        <div class="form-columns">
          <label class="field">
            <span>Variante o modelo</span>
            <input
              type="text"
              class="input"
              [(ngModel)]="draft.variant_name"
              name="variant_name"
              placeholder="Ejemplo: Matrimonial"
            />
          </label>

          <label class="field">
            <span>Talla</span>
            <input
              type="text"
              class="input"
              [(ngModel)]="draft.size_label"
              name="size_label"
              placeholder="Ejemplo: Unitalla"
            />
          </label>
        </div>

        <div class="form-columns">
          <label class="field">
            <span>Color</span>
            <input
              type="text"
              class="input"
              [(ngModel)]="draft.color_name"
              name="color_name"
              placeholder="Ejemplo: Negro"
            />
          </label>

          <label class="field">
            <span>Precio costo</span>
            <input
              type="number"
              min="0"
              step="0.01"
              class="input"
              [(ngModel)]="draft.unit_price"
              name="unit_price"
              placeholder="Ejemplo: 399"
            />
          </label>
        </div>

        <label class="field">
          <span>Imagenes del item</span>
          <div class="upload-actions">
            <button
              type="button"
              class="camera-btn"
              (click)="openPicker(cameraInput)"
              [disabled]="uploadingImages() || remainingImageSlots() === 0"
            >
              <svg class="camera-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M4 7h4l2-2h4l2 2h4v12H4z"></path>
                <circle cx="12" cy="13" r="3"></circle>
              </svg>
              <span>{{ uploadingImages() ? "Subiendo..." : "Agregar imagenes" }}</span>
            </button>
          </div>

          <input
            #cameraInput
            type="file"
            class="visually-hidden"
            accept="image/*"
            multiple
            (change)="onImageFilesSelected($event)"
          />
          <small>Maximo 5MB por imagen. Puedes subir hasta 8 por item ({{ remainingImageSlots() }} restantes).</small>
        </label>

        @if (draft.image_urls.length > 0) {
          <div class="image-grid">
            @for (url of draft.image_urls; track url; let imageIndex = $index) {
              <article class="image-card">
                <img [src]="url" alt="Imagen de inventario" />
                <button type="button" class="image-remove" (click)="removeDraftImage(imageIndex)">Quitar</button>
              </article>
            }
          </div>
        }

        <label class="field">
          <span>Notas</span>
          <textarea
            class="input textarea"
            [(ngModel)]="draft.notes"
            name="notes"
            rows="3"
            placeholder="Motivo, condicion de la pieza, detalle de devolucion"
          ></textarea>
        </label>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary" [disabled]="saving() || uploadingImages()">
            {{ saving() ? "Guardando..." : editingId() ? "Guardar cambios" : "Agregar a inventario" }}
          </button>
          <button type="button" class="btn btn-outline" (click)="startCreate()">Limpiar</button>
        </div>
      </form>
    </article>

    <article class="panel list-panel">
      <div class="list-header">
        <h2>Items registrados</h2>
        <p>{{ filteredRows().length }} resultado(s)</p>
      </div>

      @if (loading()) {
        <p class="empty">Cargando inventario...</p>
      } @else if (filteredRows().length === 0) {
        <div class="empty-state">
          <p class="empty">No hay items para mostrar con esos filtros.</p>
          @if (hasActiveFilters()) {
            <button type="button" class="btn btn-outline" (click)="clearFilters()">Restablecer filtros</button>
          }
        </div>
      } @else {
        <div class="inventory-list">
          @for (item of filteredRows(); track item.inventory_id) {
            <article class="inventory-card" [class.card-out]="item.quantity_on_hand === 0">
              <header>
                <div>
                  <h3>{{ item.title }}</h3>
                </div>
                <span class="stock-tag" [class]="'stock-tag ' + stockClass(item.quantity_on_hand)">
                  {{ stockTag(item.quantity_on_hand) }}
                </span>
              </header>

              @if (primaryImage(item); as imageUrl) {
                <div class="card-image-wrap">
                  <img [src]="imageUrl" alt="Imagen de {{ item.title }}" class="card-image" />
                  @if (item.image_urls.length > 1) {
                    <span class="image-count">+{{ item.image_urls.length - 1 }} foto(s)</span>
                  }
                </div>
              } @else {
                <div class="card-image-wrap">
                  <div class="card-image-placeholder" aria-hidden="true">
                    <svg class="card-image-placeholder-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M4 7h4l2-2h4l2 2h4v12H4z"></path>
                      <circle cx="12" cy="13" r="3"></circle>
                    </svg>
                    <span>Sin foto</span>
                  </div>
                </div>
              }

              <div class="meta-grid">
                <p><strong>Categoria:</strong> {{ item.category_hint || "Sin categoria" }}</p>
                <p><strong>Proveedor:</strong> {{ supplierName(item.supplier_id) }}</p>
                <p><strong>Variante:</strong> {{ item.variant_name || "Sin variante" }}</p>
                <p><strong>Color:</strong> {{ item.color_name || "Sin color" }}</p>
                <p><strong>Talla:</strong> {{ item.size_label || "Sin talla" }}</p>
                <p><strong>Precio:</strong> {{ item.unit_price ? ('$' + item.unit_price) : "Sin precio" }}</p>
              </div>

              @if (item.notes) {
                <p class="notes">{{ item.notes }}</p>
              }

              <div class="qty-row">
                <strong>Cantidad:</strong>
                <div class="qty-control">
                  <button
                    type="button"
                    class="qty-btn"
                    (click)="adjustQty(item, -1)"
                    [disabled]="item.quantity_on_hand === 0 || isBusy(item.inventory_id)"
                    [attr.aria-label]="'Disminuir cantidad de ' + item.title"
                  >
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <path d="M5 12h14"></path>
                    </svg>
                  </button>
                  <span class="qty-value">{{ item.quantity_on_hand }}</span>
                  <button
                    type="button"
                    class="qty-btn"
                    (click)="adjustQty(item, 1)"
                    [disabled]="isBusy(item.inventory_id)"
                    [attr.aria-label]="'Aumentar cantidad de ' + item.title"
                  >
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <path d="M12 5v14"></path>
                      <path d="M5 12h14"></path>
                    </svg>
                  </button>
                </div>
              </div>

              <div class="card-actions">
                <button type="button" class="btn btn-outline" (click)="startEdit(item)">
                  <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="M12 20h9"></path>
                    <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
                  </svg>
                  <span>Editar</span>
                </button>
                <button
                  type="button"
                  class="btn btn-danger"
                  (click)="askRemove(item)"
                  [disabled]="isBusy(item.inventory_id)"
                >
                  <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="M3 6h18"></path>
                    <path d="M8 6V4h8v2"></path>
                    <path d="M19 6l-1 14H6L5 6"></path>
                    <path d="M10 11v6"></path>
                    <path d="M14 11v6"></path>
                  </svg>
                  <span>{{ isBusy(item.inventory_id) ? "Procesando..." : "Eliminar" }}</span>
                </button>
              </div>
            </article>
          }
        </div>
      }
    </article>
  </section>
</section>

@if (categoryTreeOpen()) {
  <div class="tree-overlay" (click)="closeCategoryTree()"></div>
  <aside class="category-tree-sheet" role="dialog" aria-modal="true" aria-label="Selector de categoria">
    <header class="sheet-header">
      <h3>Seleccionar categoria final</h3>
      <button type="button" class="btn btn-ghost" (click)="closeCategoryTree()">Cerrar</button>
    </header>

    <div class="sheet-path">
      <button type="button" class="btn btn-outline" (click)="goBackCategoryTree()" [disabled]="!categoryTreeParentId()">
        Subir nivel
      </button>

      @if (categoryTreeBreadcrumb().length === 0) {
        <p>Raiz</p>
      } @else {
        <p>
          @for (crumb of categoryTreeBreadcrumb(); track crumb.id; let isLast = $last) {
            <span>{{ crumb.name }}</span>@if (!isLast) { <span> > </span> }
          }
        </p>
      }
    </div>

    @if (categoryTreeRows().length === 0) {
      <p class="empty">No hay subcategorias en este nivel.</p>
    } @else {
      <div class="sheet-list">
        @for (category of categoryTreeRows(); track category.id) {
          <article class="sheet-row">
            <button type="button" class="sheet-main" (click)="openCategoryBranch(category)">
              <span>{{ category.name }}</span>
              @if (hasCategoryChildren(category.id)) {
                <small>Abrir</small>
              } @else {
                <small>Seleccionar</small>
              }
            </button>
          </article>
        }
      </div>
    }
  </aside>
}

@if (deleteDialogItem(); as itemToDelete) {
  <div class="tree-overlay" (click)="cancelRemove()"></div>
  <aside class="confirm-sheet" role="dialog" aria-modal="true" aria-label="Confirmar eliminacion">
    <h3>Eliminar item</h3>
    <p>
      Vas a eliminar <strong>{{ itemToDelete.title }}</strong>. Esta accion no se puede deshacer.
    </p>
    <div class="confirm-actions">
      <button type="button" class="btn btn-outline" (click)="cancelRemove()">Cancelar</button>
      <button type="button" class="btn btn-danger" (click)="confirmRemove()" [disabled]="isBusy(itemToDelete.inventory_id)">
        {{ isBusy(itemToDelete.inventory_id) ? "Procesando..." : "Eliminar item" }}
      </button>
    </div>
  </aside>
}
