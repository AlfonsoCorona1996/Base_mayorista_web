<div class="catalog-page">
  <header class="catalog-header">
    <div>
      <h1 class="catalog-title">Catalogo publicado</h1>
      <p class="catalog-subtitle">Aqui aparecen los productos en estado validated.</p>
    </div>
    <button type="button" class="btn btn-secondary" (click)="reload()" [disabled]="loading()">
      {{ loading() ? "Actualizando..." : "Actualizar" }}
    </button>
  </header>

  @if (error()) {
    <div class="alert-error"><strong>Error:</strong> {{ error() }}</div>
  }

  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Cargando catalogo...</p>
    </div>
  } @else {
    <section class="filters-card">
      <div class="filters-row">
        <input
          type="text"
          class="input"
          [ngModel]="searchTerm()"
          (ngModelChange)="searchTerm.set($event)"
          placeholder="Buscar por nombre, proveedor, categoria o color"
        />
      </div>

      <div class="filters-grid">
        <select class="input" [ngModel]="supplierFilter()" (ngModelChange)="supplierFilter.set($event)">
          <option value="">Proveedor (todos)</option>
          @for (opt of suppliersOptions(); track opt.id) {
            <option [value]="opt.id">{{ opt.label }}</option>
          }
        </select>

        <select class="input" [ngModel]="categoryFilter()" (ngModelChange)="categoryFilter.set($event)">
          <option value="">Categoria (todas)</option>
          @for (opt of categoriesOptions(); track opt) {
            <option [value]="opt">{{ opt }}</option>
          }
        </select>

        <select class="input" [ngModel]="colorFilter()" (ngModelChange)="colorFilter.set($event)">
          <option value="">Color (todos)</option>
          @for (opt of colorsOptions(); track opt) {
            <option [value]="opt">{{ opt }}</option>
          }
        </select>

        <select class="input" [ngModel]="statusFilter()" (ngModelChange)="onStatusFilterChange($event)">
          @for (opt of stockFilterOptions; track opt.value) {
            <option [ngValue]="opt.value">{{ opt.label }}</option>
          }
        </select>

        <label class="stock-toggle">
          <input
            type="checkbox"
            [ngModel]="hideOutOfStock()"
            (ngModelChange)="onToggleHideOutOfStock($event)"
          />
          <span>Ocultar agotados</span>
        </label>

        <button type="button" class="btn btn-outline" (click)="clearFilters()" [disabled]="!hasActiveFilters()">
          Limpiar
        </button>
      </div>

      <p class="results-info">
        Mostrando {{ filteredRows().length }} de {{ rows().length }} producto{{ rows().length !== 1 ? 's' : '' }}
      </p>
    </section>

    @if (filteredRows().length === 0) {
      <section class="empty-state">
        <h2>No hay productos para mostrar</h2>
        <p>Valida un producto o ajusta filtros para verlo aqui.</p>
      </section>
    } @else {
      <section class="catalog-grid">
        @for (doc of filteredRows(); track doc.normalized_id) {
          <article class="catalog-card" (click)="open(doc.normalized_id)">
            <div class="card-image-wrap">
              @if (getCoverImage(doc); as cover) {
                <img [src]="cover" alt="{{ doc.listing.title || 'Producto' }}" class="card-image" />
              } @else {
                <div class="card-image-placeholder">Sin imagen</div>
              }
            </div>

            <div class="card-content">
              <div class="card-title-row">
                <h3 class="card-title">{{ doc.listing.title || "(sin titulo)" }}</h3>
                <span class="stock-pill" [class]="'stock-pill ' + stockClass(getStockState(doc))">
                  {{ stockLabel(getStockState(doc)) }}
                </span>
              </div>

              <div class="chips">
                <span class="chip">{{ supplierName(doc.supplier_id) }}</span>
                <span class="chip">{{ doc.listing.category_hint || "Sin categoria" }}</span>
                <span class="chip">{{ doc.listing.items.length }} variante{{ doc.listing.items.length !== 1 ? 's' : '' }}</span>
              </div>

              <div class="colors-line">
                <strong>Colores:</strong>
                @if (getColorNames(doc).length > 0) {
                  <span>{{ getColorNames(doc).join(", ") }}</span>
                } @else {
                  <span>sin colores</span>
                }
              </div>
            </div>

            <div class="card-footer">
              <span>Actualizado {{ timeAgo(doc.updated_at ?? doc.created_at) }}</span>
              <div class="card-footer-actions">
                <button
                  type="button"
                  class="btn btn-danger"
                  (click)="markProductOutOfStock(doc.normalized_id, $event)"
                  [disabled]="isBusy(doc.normalized_id)"
                >
                  {{ isBusy(doc.normalized_id) ? "Guardando..." : "Agotar" }}
                </button>
                <button type="button" class="btn btn-primary" (click)="open(doc.normalized_id); $event.stopPropagation()">
                  Gestionar
                </button>
              </div>
            </div>
          </article>
        }
      </section>

      @if (hasMore()) {
        <div class="more-wrapper">
          <button class="btn btn-secondary" (click)="loadMore()" [disabled]="loadingMore()">
            {{ loadingMore() ? "Cargando..." : "Cargar mas" }}
          </button>
        </div>
      }
    }
  }
</div>
