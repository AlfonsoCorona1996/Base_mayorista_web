<!-- 
  Review Page - Mobile First UX
  Optimizado para pantallas t√°ctiles
-->
<div class="review-container">
  <!-- Header -->
  <header class="review-header">
    <button class="btn-icon" (click)="goInbox()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
    </button>
    <div class="header-title-section">
      <h1 class="review-title">üìù Revisi√≥n de Producto</h1>
      <p class="review-subtitle">Validar y editar informaci√≥n</p>
    </div>
    <div class="header-spacer"></div>
  </header>

  <!-- Error -->
  @if (error()) {
    <div class="alert alert-error">{{ error() }}</div>
  }

  <!-- Loading -->
  @if (loading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Cargando...</p>
    </div>
  } @else if (draft(); as d) {

    <!-- =================================================================
         SECCI√ìN 1: INFORMACI√ìN B√ÅSICA
         ================================================================= -->
    <section class="card">
      <h2 class="section-title">Informaci√≥n b√°sica</h2>

      <!-- Proveedor -->
      <div class="form-group">
        <label class="label">Proveedor *</label>
        <select 
          [(ngModel)]="d.supplier_id" 
          class="input"
          (change)="onSupplierChange()"
        >
          <option [value]="null">Seleccionar proveedor...</option>
          @for (sup of activeSuppliers(); track sup.supplier_id) {
            <option [value]="sup.supplier_id">{{ sup.display_name }}</option>
          }
        </select>
        <small class="hint">Proveedor de donde viene este producto</small>
      </div>

      <!-- T√≠tulo -->
      <div class="form-group">
        <label class="label">T√≠tulo del producto *</label>
        <input
          type="text"
          [(ngModel)]="d.listing.title"
          class="input"
          placeholder="Ej: Cobertor Matrimonial"
        />
      </div>

      <!-- Categor√≠a con b√∫squeda -->
      <div class="form-group">
        <label class="label">Categor√≠a *</label>
        
        <!-- Input con b√∫squeda -->
        <div class="category-input-wrapper">
          <input
            type="text"
            [(ngModel)]="categorySearch"
            (input)="onCategorySearch()"
            (focus)="showCategoryDropdown.set(true)"
            class="input"
            placeholder="Buscar categor√≠a..."
            [value]="d.listing.category_hint || ''"
          />
          
          <!-- Dropdown de resultados -->
          @if (showCategoryDropdown() && filteredCategories().length > 0) {
            <div class="dropdown">
              @for (cat of filteredCategories(); track cat.id) {
                <button
                  type="button"
                  class="dropdown-item"
                  [class.selected]="d.listing.category_hint === cat.fullPath"
                  (click)="selectCategory(cat)"
                >
                  <span class="category-level-{{cat.level}}">{{ cat.fullPath }}</span>
                </button>
              }
            </div>
          }
        </div>
        <small class="hint">Categor√≠a estandarizada del producto</small>
      </div>
    </section>

    <!-- =================================================================
         SECCI√ìN 2: IM√ÅGENES
         ================================================================= -->
    <section class="card">
      <h2 class="section-title">Im√°genes y Colores</h2>
      
      <!-- Subsecci√≥n: Imagen de Portada -->
      <div class="subsection">
        <h3 class="subsection-title">üñºÔ∏è Imagen de Portada</h3>
        <p class="subsection-hint">
          Esta es la imagen principal que se muestra en la vista general del producto (por ejemplo, todas las carteras juntas). 
          <strong>No es un color,</strong> es la imagen de presentaci√≥n.
        </p>
        
        @if (coverUrl()) {
          <div class="cover-preview-main">
            <div class="cover-preview-image-wrapper">
              <img [src]="coverUrl()" class="cover-preview-image" alt="Portada del producto"/>
              <div class="cover-badge-large">‚úì Portada Actual</div>
            </div>
            <button 
              type="button" 
              class="btn btn-sm btn-secondary" 
              (click)="openCoverSelector()"
            >
              üîÑ Cambiar Portada
            </button>
          </div>
        } @else {
          <button 
            type="button" 
            class="btn btn-primary" 
            (click)="openCoverSelector()"
          >
            + Seleccionar Imagen de Portada
          </button>
        }
      </div>

      <hr class="divider"/>

      <!-- Subsecci√≥n: Im√°genes de Colores -->
      <div class="subsection">
        <div class="subsection-header">
          <div>
            <h3 class="subsection-title">üé® Colores Globales del Producto</h3>
            <p class="subsection-hint">
              Define aqu√≠ TODOS los colores disponibles del producto. Luego podr√°s asignarlos a cada variante.
            </p>
          </div>
          <div class="colors-actions">
            <button type="button" class="btn btn-sm btn-primary" (click)="addGlobalColorWithImage()">
              üì∑ Con imagen
            </button>
            <button type="button" class="btn btn-sm btn-secondary" (click)="addGlobalColorWithoutImage()">
              ‚úèÔ∏è Solo nombre
            </button>
          </div>
        </div>

        <!-- Galer√≠a de colores globales -->
        <div class="images-gallery">
          @for (color of (d.product_colors || []); track $index; let i = $index) {
            <div class="gallery-item">
              <div class="gallery-item-image-wrapper">
                @if (hasColorImage(color.image_url)) {
                  <img [src]="color.image_url" class="gallery-item-image" alt="Imagen de color"/>
                } @else {
                  <div class="gallery-item-placeholder">
                    <span>üì∑</span>
                    <span class="placeholder-text">Sin imagen</span>
                  </div>
                }
                
                <!-- Bot√≥n eliminar (visible en hover) -->
                <button
                  type="button"
                  class="gallery-item-remove"
                  (click)="removeGlobalColorAt(i)"
                  title="Eliminar color"
                >
                  ‚úï
                </button>
              </div>
              
              <!-- Editor de color -->
              <div class="gallery-item-color">
                <label class="gallery-label">üé® Color</label>
                <input
                  type="text"
                  [(ngModel)]="color.name"
                  class="gallery-input"
                  placeholder="Ej: negro, rosa..."
                  (blur)="touchDraft()"
                />
              </div>
            </div>
          }
        </div>

        @if ((d.product_colors || []).length === 0) {
          <p class="text-muted">No hay colores definidos. Agrega al menos uno usando los botones de arriba.</p>
        }
      </div>
    </section>

    <!-- =================================================================
         SECCI√ìN 3: VARIANTES Y PRECIOS
         ================================================================= -->
    <section class="card">
      <div class="section-header">
        <h2 class="section-title">Variantes y precios</h2>
        <button type="button" class="btn btn-sm btn-primary" (click)="addVariant()">
          + Agregar variante
        </button>
      </div>

      <!-- Checkbox: ¬øColores por variante? -->
      <div class="form-group">
        <label class="checkbox-label">
          <input 
            type="checkbox" 
            [checked]="hasVariantColors()"
            (change)="toggleVariantColors($any($event.target).checked)"
            class="checkbox"
          />
          <span>Las variantes tienen colores diferentes</span>
        </label>
        <small class="hint">
          Marca esto si cada variante tiene un color espec√≠fico (ej: rosa, azul). 
          Si todas las variantes comparten los mismos colores, d√©jalo sin marcar.
        </small>
        @if (hasVariantColors()) {
          <div class="alert alert-success">
            ‚úÖ <strong>Modo Colores Activado:</strong> Ahora puedes asignar im√°genes (con sus colores) a cada variante. 
            Los colores que editaste en la galer√≠a se asignar√°n autom√°ticamente.
          </div>
        }
      </div>

      <!-- Descuentos globales -->
      <div class="global-discounts">
        <div class="global-discounts-header">
          <h3 class="subsection-title">Descuentos globales</h3>
          <button type="button" class="btn btn-sm btn-primary" (click)="syncGlobalDiscountsToVariants()">
            üîÑ Aplicar a todas las variantes
          </button>
        </div>
        <small class="hint">Define descuentos que se aplicar√°n autom√°ticamente a todas las variantes</small>
        
        @for (tier of d.listing.price_tiers_global; track $index; let i = $index) {
          <div class="discount-row">
            <input
              type="text"
              [(ngModel)]="tier.tier_name"
              class="input input-sm"
              placeholder="Tipo (ej: mayorista)"
              style="flex: 1;"
              [readonly]="tier.tier_name === 'publico'"
            />
            <input
              type="number"
              [(ngModel)]="tier.discount_percent"
              class="input input-sm"
              placeholder="%"
              style="width: 80px;"
              [readonly]="tier.tier_name === 'publico'"
            />
            <span class="discount-symbol">%</span>
            <button
              type="button"
              class="btn-icon-sm btn-danger"
              (click)="removeGlobalDiscount(i)"
              [disabled]="d.listing.price_tiers_global.length <= 1 || tier.tier_name === 'publico'"
            >
              ‚úï
            </button>
          </div>
        }
        <button type="button" class="btn btn-sm btn-outline" (click)="addGlobalDiscount()">
          + Agregar descuento
        </button>
      </div>

      <!-- Lista de variantes -->
      <div class="variants-list">
        @for (variant of d.listing.items; track $index; let i = $index) {
          <div class="variant-card">
            <div class="variant-header">
              <span class="variant-number">#{{ i + 1 }}</span>
              <button
                type="button"
                class="btn-icon-sm btn-danger"
                (click)="removeVariant(i)"
                [disabled]="d.listing.items.length <= 1"
              >
                ‚úï
              </button>
            </div>

            <!-- Imagen asociada -->
            @if (variant.image_url) {
              <div class="variant-image-preview">
                <img [src]="variant.image_url" alt="Variante"/>
              </div>
            }

            <!-- Nombre de variante -->
            <div class="form-group">
              <label class="label">Nombre de variante</label>
              <input
                type="text"
                [(ngModel)]="variant.variant_name"
                class="input"
                placeholder="Ej: Matrimonial Rosa"
              />
            </div>

            <div class="form-group">
              <label class="label">SKU</label>
              @if (variant.sku) {
                <input
                  type="text"
                  [value]="variant.sku"
                  class="input"
                  readonly
                />
                <small class="hint">Identificador √∫nico por variante/talla (no editable)</small>
              } @else {
                <small class="hint">Se generar√° autom√°ticamente al guardar/validar.</small>
              }
            </div>

            <!-- Colores asignados (solo si hasVariantColors est√° activado) -->
            @if (hasVariantColors()) {
              <div class="form-group">
                <div class="colors-header">
                  <label class="label">Colores de esta variante</label>
                  <button type="button" class="btn btn-sm btn-primary" (click)="assignColorToVariant(i)">
                    + Asignar color
                  </button>
                </div>
                
                <div class="colors-hint">
                  üí° <strong>Los colores se definen arriba</strong> en "Colores Globales". Aqu√≠ solo seleccionas cu√°les aplican para esta variante.
                </div>
                
                <!-- Lista de colores asignados (READ-ONLY) -->
                @if (variant.colors && variant.colors.length > 0) {
                  <div class="colors-list-readonly">
                    @for (color of variant.colors; track $index; let ci = $index) {
                      <div class="color-chip">
                        <!-- Miniatura de imagen o placeholder -->
                        @if (variant.image_urls && variant.image_urls[ci]) {
                          <img 
                            [src]="variant.image_urls[ci]" 
                            alt="{{color}}"
                            class="color-chip-image"
                          />
                        } @else {
                          <div class="color-chip-placeholder">
                            üì∑
                          </div>
                        }
                        
                        <!-- Nombre del color (READ-ONLY) -->
                        <span class="color-chip-name">{{ color || 'Sin nombre' }}</span>
                        
                        <!-- Bot√≥n para eliminar color de esta variante -->
                        <button
                          type="button"
                          class="color-chip-remove"
                          (click)="removeColorFromVariant(i, ci)"
                          title="Quitar este color de la variante"
                        >
                          ‚úï
                        </button>
                      </div>
                    }
                  </div>
                } @else {
                  <div class="empty-state">
                    <p>No hay colores asignados. Click en "Asignar color" para agregar.</p>
                  </div>
                }
              </div>
            }

            <!-- Stock -->
            <div class="form-group">
              <label class="label">Disponibilidad</label>
              <select [(ngModel)]="variant.stock_state" class="input">
                <option value="in_stock">‚úì Disponible</option>
                <option value="last_pair">‚ö†Ô∏è √öltima pieza</option>
                <option value="unknown_qty">‚ùì Cantidad desconocida</option>
              </select>
            </div>

            <!-- Precios -->
            <div class="prices-section">
              <label class="label">Precios</label>
              @for (price of variant.prices; track $index; let pi = $index) {
                <div class="price-row">
                  <input
                    type="text"
                    [(ngModel)]="price.tier_name"
                    class="input input-sm"
                    placeholder="Tipo"
                    style="flex: 1;"
                  />
                  <input
                    type="number"
                    [(ngModel)]="price.amount"
                    class="input input-sm"
                    placeholder="0.00"
                    style="width: 100px;"
                  />
                  <span class="currency">{{ price.currency }}</span>
                  <button
                    type="button"
                    class="btn-icon-sm btn-danger"
                    (click)="removePriceFromVariant(i, pi)"
                    [disabled]="variant.prices.length <= 1"
                  >
                    ‚úï
                  </button>
                </div>
              }
              <button type="button" class="btn btn-sm btn-outline" (click)="addPriceToVariant(i)">
                + Precio
              </button>
            </div>

            <!-- Notas -->
            <div class="form-group">
              <label class="label">Notas</label>
              <textarea
                [(ngModel)]="variant.notes"
                class="input"
                rows="2"
                placeholder="Notas adicionales..."
              ></textarea>
            </div>
          </div>
        }
      </div>

      @if (d.listing.items.length === 0) {
        <div class="empty-state">
          <p>No hay variantes. Agrega al menos una para continuar.</p>
        </div>
      }
    </section>

    <!-- =================================================================
         SECCI√ìN 4: CONTEXTO RAW (SOLO LECTURA)
         ================================================================= -->
    <section class="card card-secondary">
      <h2 class="section-title">Mensaje original (solo lectura)</h2>
      <div class="raw-message">
        {{ rawText() || "(sin texto)" }}
      </div>
      <small class="hint">ID: {{ id }}</small>
    </section>

    <!-- =================================================================
         ACCIONES FINALES
         ================================================================= -->
    <div class="actions-bar">
      <button type="button" class="btn btn-secondary" (click)="save()">
        üíæ Guardar cambios
      </button>
      <button type="button" class="btn btn-primary" (click)="validate()">
        ‚úì Validar y publicar
      </button>
      <button type="button" class="btn btn-danger" (click)="reject()">
        ‚úï Rechazar
      </button>
    </div>
  }
</div>

<!-- Modal para seleccionar imagen -->
@if (showImagePicker()) {
  <div class="modal-overlay" (click)="closeImagePicker()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>Seleccionar o Subir Imagen</h3>
      
      <!-- Opci√≥n de subir nueva imagen -->
      <div class="upload-section">
        <label class="upload-button">
          <input 
            type="file" 
            accept="image/*" 
            (change)="uploadNewImage($event)"
            [disabled]="uploading()"
            style="display: none;"
          />
          @if (uploading()) {
            <span class="btn btn-primary" style="pointer-events: none;">‚è≥ Subiendo...</span>
          } @else {
            <span class="btn btn-primary">üì§ Subir Nueva Imagen</span>
          }
        </label>
        @if (uploadError()) {
          <div class="upload-error">{{ uploadError() }}</div>
        }
      </div>
      
      <div class="divider-text">
        <span>O selecciona una existente</span>
      </div>
      
      <!-- Im√°genes existentes -->
      <div class="images-grid">
        @for (img of visibleRawImages(); track img) {
          <button type="button" class="image-card-clickable" (click)="assignImageToColor(img)">
            <img [src]="img" class="image-thumb" alt="Imagen"/>
            @if (imageColors[img]) {
              <div class="image-color-badge">{{ imageColors[img] }}</div>
            }
          </button>
        }
      </div>
      
      <button type="button" class="btn btn-secondary" (click)="closeImagePicker()">Cancelar</button>
    </div>
  </div>
}
