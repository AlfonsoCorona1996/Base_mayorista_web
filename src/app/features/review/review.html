<!-- Review Page - Mobile First UX -->
<div class="review-container">
  <header class="review-header">
    <button class="btn-icon" (click)="goInbox()" aria-label="Volver al inbox" title="Volver">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
    </button>
    <div class="header-title-section">
      <h1 class="review-title">Revision de Producto</h1>
      <p class="review-subtitle">Validar y editar informacion</p>
    </div>
    <div class="header-spacer"></div>
  </header>

  @if (error()) {
    <div class="alert alert-error">{{ error() }}</div>
  }

  @if (loading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Cargando...</p>
    </div>
  } @else if (draft(); as d) {
    <section class="card">
      <h2 class="section-title">Informacion basica</h2>

      <div class="form-group">
        <label class="label">Proveedor *</label>
        <select
          [(ngModel)]="d.supplier_id"
          class="input"
          (change)="onSupplierChange()"
        >
          <option [value]="null">Seleccionar proveedor...</option>
          @for (sup of activeSuppliers(); track sup.supplier_id) {
            <option [value]="sup.supplier_id">{{ sup.display_name }}</option>
          }
        </select>
        <small class="hint">Proveedor de donde viene este producto</small>
      </div>

      <div class="form-group">
        <label class="label">Titulo del producto *</label>
        <input
          type="text"
          [(ngModel)]="d.listing.title"
          class="input"
          placeholder="Ej: Cobertor Matrimonial"
        />
      </div>

      <div class="form-group">
        <label class="label">Categoria *</label>
        <div class="category-input-wrapper">
          <input
            type="text"
            [(ngModel)]="categorySearch"
            (input)="onCategorySearch()"
            (focus)="showCategoryDropdown.set(true)"
            class="input"
            placeholder="Buscar categoria..."
            [value]="d.listing.category_hint || ''"
          />

          @if (showCategoryDropdown() && filteredCategories().length > 0) {
            <div class="dropdown">
              @for (cat of filteredCategories(); track cat.id) {
                <button
                  type="button"
                  class="dropdown-item"
                  [class.selected]="d.listing.category_hint === cat.fullPath"
                  (click)="selectCategory(cat)"
                >
                  <span class="category-level-{{cat.level}}">{{ cat.fullPath }}</span>
                </button>
              }
            </div>
          }
        </div>
        <small class="hint">Categoria estandarizada del producto</small>
      </div>
    </section>

    <section class="card">
      <h2 class="section-title">Imagenes y Colores</h2>

      <div class="subsection">
        <h3 class="subsection-title">Imagen de Portada</h3>
        <p class="subsection-hint">
          Esta es la imagen principal que se muestra en la vista general del producto.
          <strong>No es un color,</strong> es la imagen de presentacion.
        </p>

        @if (coverUrl()) {
          <div class="cover-preview-main">
            <div class="cover-preview-image-wrapper">
              <img [src]="coverUrl()" class="cover-preview-image" alt="Portada del producto"/>
              <div class="cover-badge-large">Portada Actual</div>
            </div>
            <button
              type="button"
              class="btn btn-sm btn-secondary"
              (click)="openCoverSelector()"
            >
              Cambiar Portada
            </button>
          </div>
        } @else {
          <button
            type="button"
            class="btn btn-primary"
            (click)="openCoverSelector()"
          >
            + Seleccionar Imagen de Portada
          </button>
        }
      </div>

      <hr class="divider"/>

      <div class="subsection">
        <div class="subsection-header">
          <div>
            <h3 class="subsection-title">Colores Globales del Producto</h3>
            <p class="subsection-hint">
              Define aqui TODOS los colores disponibles del producto.
            </p>
          </div>
          <div class="colors-actions">
            <button type="button" class="btn btn-sm btn-primary" (click)="addGlobalColorWithImage()">
              Con imagen
            </button>
            <button type="button" class="btn btn-sm btn-secondary" (click)="addGlobalColorWithoutImage()">
              Solo nombre
            </button>
          </div>
        </div>

        <div class="images-gallery">
          @for (color of (d.product_colors || []); track $index; let i = $index) {
            <div class="gallery-item">
              <div class="gallery-item-image-wrapper">
                @if (hasColorImage(color.image_url)) {
                  <img [src]="color.image_url" class="gallery-item-image" alt="Imagen de color"/>
                } @else {
                  <div class="gallery-item-placeholder">
                    <span class="placeholder-icon" aria-hidden="true">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 7h4l2-2h4l2 2h4v12H4z"></path>
                        <circle cx="12" cy="13" r="3"></circle>
                      </svg>
                    </span>
                    <span class="placeholder-text">Sin imagen</span>
                  </div>
                }

                <button
                  type="button"
                  class="gallery-item-remove"
                  (click)="removeGlobalColorAt(i)"
                  aria-label="Eliminar color global"
                  title="Eliminar color"
                >
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="M3 6h18"></path>
                    <path d="M8 6V4h8v2"></path>
                    <path d="M19 6l-1 14H6L5 6"></path>
                    <path d="M10 11v6"></path>
                    <path d="M14 11v6"></path>
                  </svg>
                </button>
              </div>

              <div class="gallery-item-color">
                <label class="gallery-label">Color</label>
                <input
                  type="text"
                  [(ngModel)]="color.name"
                  class="gallery-input"
                  placeholder="Ej: negro, rosa..."
                  (focus)="onGlobalColorFocus(i, color.name)"
                  (blur)="onGlobalColorBlur(i)"
                />
              </div>
            </div>
          }
        </div>

        @if ((d.product_colors || []).length === 0) {
          <p class="text-muted">No hay colores definidos. Agrega al menos uno usando los botones de arriba.</p>
        }
      </div>
    </section>

    <section class="card">
      <div class="section-header">
        <h2 class="section-title">Variantes y precios</h2>
        <button type="button" class="btn btn-sm btn-primary" (click)="addVariant()">
          + Agregar variante
        </button>
      </div>

      <div class="form-group">
        <label class="checkbox-label">
          <input
            type="checkbox"
            class="checkbox"
            [checked]="hasVariantColors()"
            (change)="toggleVariantColors($any($event.target).checked)"
          />
          <span>Esta variante maneja colores distintos</span>
        </label>
        <small class="hint">Por defecto, los colores globales se aplican automaticamente a todas las variantes.</small>
      </div>

      <div class="variants-list">
        @for (variant of d.listing.items; track $index; let i = $index) {
          <div class="variant-card">
            <div class="variant-header">
              <span class="variant-number">#{{ i + 1 }}</span>
              <button
                type="button"
                class="btn-icon-sm btn-danger"
                (click)="removeVariant(i)"
                [disabled]="d.listing.items.length <= 1"
                aria-label="Eliminar variante"
                title="Eliminar variante"
              >
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <path d="M3 6h18"></path>
                  <path d="M8 6V4h8v2"></path>
                  <path d="M19 6l-1 14H6L5 6"></path>
                  <path d="M10 11v6"></path>
                  <path d="M14 11v6"></path>
                </svg>
              </button>
            </div>

            @if (variant.image_url) {
              <div class="variant-image-preview">
                <img [src]="variant.image_url" alt="Variante"/>
              </div>
            }

            <div class="form-group">
              <label class="label">Nombre de variante</label>
              <input
                type="text"
                [(ngModel)]="variant.variant_name"
                class="input"
                placeholder="Ej: Matrimonial Rosa"
              />
            </div>

            <div class="form-group">
              <label class="label">SKU</label>
              @if (variant.sku) {
                <input type="text" [value]="variant.sku" class="input" readonly />
                <small class="hint">Identificador unico por variante/talla (no editable)</small>
              } @else {
                <small class="hint">Se generara automaticamente al guardar/validar.</small>
              }
            </div>

            @if (hasVariantColors()) {
              <div class="form-group">
                <div class="colors-header">
                  <label class="label">Colores de esta variante</label>
                  <button type="button" class="btn btn-sm btn-primary" (click)="assignColorToVariant(i)">
                    + Asignar color
                  </button>
                </div>

                <div class="colors-hint">
                  Los colores se definen arriba en "Colores Globales". Aqui seleccionas cuales aplican para esta variante.
                </div>

                @if ((variant.color_stock || []).length > 0) {
                  <div class="colors-list-readonly">
                    @for (entry of (variant.color_stock || []); track $index; let ci = $index) {
                      <div class="color-chip">
                        @if (getColorImage(entry.color_name); as colorImage) {
                          <img [src]="colorImage" alt="{{entry.color_name}}" class="color-chip-image" />
                        } @else {
                          <div class="color-chip-placeholder">Sin</div>
                        }

                        <span class="color-chip-name">{{ entry.color_name || 'Sin nombre' }}</span>
                        <select
                          class="input input-sm"
                          [(ngModel)]="entry.stock_state"
                          style="width: 150px;"
                          (ngModelChange)="touchDraft()"
                        >
                          @for (opt of stockOptions; track opt.value) {
                            <option [ngValue]="opt.value">{{ opt.label }}</option>
                          }
                        </select>

                        <button
                          type="button"
                          class="color-chip-remove"
                          (click)="removeColorFromVariant(i, ci)"
                          aria-label="Quitar color de la variante"
                          title="Quitar este color de la variante"
                        >
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path d="M3 6h18"></path>
                            <path d="M8 6V4h8v2"></path>
                            <path d="M19 6l-1 14H6L5 6"></path>
                            <path d="M10 11v6"></path>
                            <path d="M14 11v6"></path>
                          </svg>
                        </button>
                      </div>
                    }
                  </div>
                } @else {
                  <div class="empty-state">
                    <p>No hay colores asignados. Click en "Asignar color" para agregar.</p>
                  </div>
                }
              </div>
            } @else {
              <div class="form-group">
                <small class="hint">Esta variante usa automaticamente los colores globales del producto.</small>
              </div>
            }

            <div class="form-group">
              <label class="label">Disponibilidad</label>
              <select [(ngModel)]="variant.stock_state" class="input">
                <option value="in_stock">Disponible</option>
                <option value="last_pair">Ultima pieza</option>
                <option value="out_of_stock">Agotado</option>
                <option value="unknown_qty">Cantidad desconocida</option>
              </select>
            </div>

            <div class="prices-section">
              <label class="label">Precios</label>
              <div class="price-row">
                <span class="price-label">Precio costo</span>
                <input
                  type="text"
                  [ngModel]="getPriceInputValue(i, 'costo')"
                  (ngModelChange)="onPriceInputChange(i, 'costo', $event)"
                  (blur)="onPriceInputBlur(i, 'costo')"
                  class="input input-sm price-input"
                  [class.input-error]="isPriceLossRisk(variant)"
                  placeholder="0.00"
                />
                <span class="currency">{{ $any(variant).prices?.currency || 'MXN' }}</span>
              </div>
              <div class="price-row">
                <span class="price-label">Precio final</span>
                <input
                  type="text"
                  [ngModel]="getPriceInputValue(i, 'final')"
                  (ngModelChange)="onPriceInputChange(i, 'final', $event)"
                  (blur)="onPriceInputBlur(i, 'final')"
                  class="input input-sm price-input"
                  [class.input-error]="isPriceLossRisk(variant)"
                />
                <span class="currency">{{ $any(variant).prices?.currency || 'MXN' }}</span>
              </div>
              <div class="price-row">
                <span class="price-label">Precio clienta</span>
                <input
                  type="text"
                  [value]="formatMoney($any(variant).prices?.precio_clienta, $any(variant).prices?.currency || 'MXN')"
                  class="input input-sm input-disabled price-input"
                  readonly
                />
                <span class="currency">{{ $any(variant).prices?.currency || 'MXN' }}</span>
              </div>
            </div>

            <div class="form-group">
              <label class="label">Notas</label>
              <textarea
                [(ngModel)]="variant.notes"
                class="input"
                rows="2"
                placeholder="Notas adicionales..."
              ></textarea>
            </div>
          </div>
        }
      </div>

      @if (d.listing.items.length === 0) {
        <div class="empty-state">
          <p>No hay variantes. Agrega al menos una para continuar.</p>
        </div>
      }
    </section>

    <section class="card card-secondary">
      <h2 class="section-title">Mensaje original (solo lectura)</h2>
      <div class="raw-message">
        {{ rawText() || "(sin texto)" }}
      </div>
      <small class="hint">ID: {{ id }}</small>
    </section>

    <div class="actions-bar">
      <button type="button" class="btn btn-secondary" (click)="save()">
        Guardar cambios
      </button>
      <button type="button" class="btn btn-primary" (click)="validate()">
        Validar y publicar
      </button>
      <button type="button" class="btn btn-danger-outline" (click)="reject()">
        Rechazar
      </button>
    </div>
  }
</div>

@if (showImagePicker()) {
  <div class="modal-overlay" (click)="closeImagePicker()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      @if (currentVariantIndex >= 0) {
        <h3>Seleccionar Color Global</h3>
        <div class="images-grid">
          @for (color of getGlobalColorOptions(); track color.name) {
            <button type="button" class="image-card-clickable" (click)="assignGlobalColorToCurrentVariant(color.name)">
              @if (hasColorImage(color.image_url)) {
                <img [src]="color.image_url!" class="image-thumb" alt="{{ color.name }}"/>
              } @else {
                <div class="gallery-item-placeholder">
                  <span class="placeholder-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M4 7h4l2-2h4l2 2h4v12H4z"></path>
                      <circle cx="12" cy="13" r="3"></circle>
                    </svg>
                  </span>
                  <span class="placeholder-text">Sin imagen</span>
                </div>
              }
              <div class="image-color-badge">{{ color.name }}</div>
            </button>
          }
        </div>
      } @else {
        <h3>Seleccionar o Subir Imagen</h3>

        <div class="upload-section">
          <label class="upload-button">
            <input
              type="file"
              accept="image/*"
              (change)="uploadNewImage($event)"
              [disabled]="uploading()"
              style="display: none;"
            />
            @if (uploading()) {
              <span class="btn btn-primary" style="pointer-events: none;">Subiendo...</span>
            } @else {
              <span class="btn btn-primary">Subir Nueva Imagen</span>
            }
          </label>
          @if (uploadError()) {
            <div class="upload-error">{{ uploadError() }}</div>
          }
        </div>

        <div class="divider-text">
          <span>O selecciona una existente</span>
        </div>

        <div class="images-grid">
          @for (img of visibleRawImages(); track img) {
            <button type="button" class="image-card-clickable" (click)="assignImageToColor(img)">
              <img [src]="img" class="image-thumb" alt="Imagen"/>
              @if (imageColors[img]) {
                <div class="image-color-badge">{{ imageColors[img] }}</div>
              }
            </button>
          }
        </div>
      }

      <button type="button" class="btn btn-secondary" (click)="closeImagePicker()">Cancelar</button>
    </div>
  </div>
}
