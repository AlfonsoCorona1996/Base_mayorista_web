<!-- 
  Review Page - Mobile First UX
  Optimizado para pantallas t√°ctiles
-->
<div class="container">
  <!-- Header -->
  <header class="header">
    <button class="btn-icon" (click)="goInbox()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
    </button>
    <h1 class="title">Revisi√≥n</h1>
    <div class="header-spacer"></div>
  </header>

  <!-- Error -->
  @if (error()) {
    <div class="alert alert-error">{{ error() }}</div>
  }

  <!-- Loading -->
  @if (loading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Cargando...</p>
    </div>
  } @else if (draft(); as d) {

    <!-- =================================================================
         SECCI√ìN 1: INFORMACI√ìN B√ÅSICA
         ================================================================= -->
    <section class="card">
      <h2 class="section-title">Informaci√≥n b√°sica</h2>

      <!-- Proveedor -->
      <div class="form-group">
        <label class="label">Proveedor *</label>
        <select 
          [(ngModel)]="d.supplier_id" 
          class="input"
          (change)="onSupplierChange()"
        >
          <option [value]="null">Seleccionar proveedor...</option>
          @for (sup of activeSuppliers(); track sup.supplier_id) {
            <option [value]="sup.supplier_id">{{ sup.display_name }}</option>
          }
        </select>
        <small class="hint">Proveedor de donde viene este producto</small>
      </div>

      <!-- T√≠tulo -->
      <div class="form-group">
        <label class="label">T√≠tulo del producto *</label>
        <input
          type="text"
          [(ngModel)]="d.listing.title"
          class="input"
          placeholder="Ej: Cobertor Matrimonial"
        />
      </div>

      <!-- Categor√≠a con b√∫squeda -->
      <div class="form-group">
        <label class="label">Categor√≠a *</label>
        
        <!-- Input con b√∫squeda -->
        <div class="category-input-wrapper">
          <input
            type="text"
            [(ngModel)]="categorySearch"
            (input)="onCategorySearch()"
            (focus)="showCategoryDropdown.set(true)"
            class="input"
            placeholder="Buscar categor√≠a..."
            [value]="d.listing.category_hint || ''"
          />
          
          <!-- Dropdown de resultados -->
          @if (showCategoryDropdown() && filteredCategories().length > 0) {
            <div class="dropdown">
              @for (cat of filteredCategories(); track cat.id) {
                <button
                  type="button"
                  class="dropdown-item"
                  [class.selected]="d.listing.category_hint === cat.fullPath"
                  (click)="selectCategory(cat)"
                >
                  <span class="category-level-{{cat.level}}">{{ cat.fullPath }}</span>
                </button>
              }
            </div>
          }
        </div>
        <small class="hint">Categor√≠a estandarizada del producto</small>
      </div>
    </section>

    <!-- =================================================================
         SECCI√ìN 2: IM√ÅGENES Y COLORES
         ================================================================= -->
    <section class="card">
      <h2 class="section-title">Im√°genes y colores</h2>

      <!-- Portada actual -->
      <div class="cover-preview">
        <label class="label">Portada</label>
        @if (coverUrl()) {
          <img [src]="coverUrl()!" class="cover-image" alt="Portada"/>
        } @else {
          <div class="cover-placeholder">Sin imagen de portada</div>
        }
      </div>

      <!-- Galer√≠a de im√°genes -->
      <div class="images-grid">
        @for (img of visibleRawImages(); track img) {
          <div class="image-card">
            <img [src]="img" class="image-thumb" alt="Imagen del producto"/>
            
            <!-- Color asignado -->
            <input
              type="text"
              [(ngModel)]="imageColors[img]"
              class="input input-sm"
              placeholder="Color..."
            />

            <!-- Acciones -->
            <div class="image-actions">
              <button
                type="button"
                class="btn btn-sm"
                [class.btn-primary]="coverUrl() === img"
                (click)="setCover(img)"
              >
                @if (coverUrl() === img) {
                  ‚úì Portada
                } @else {
                  Portada
                }
              </button>
              <button
                type="button"
                class="btn btn-sm btn-danger"
                (click)="removeImage(img)"
              >
                Quitar
              </button>
            </div>
          </div>
        }
      </div>

      @if (visibleRawImages().length === 0) {
        <p class="text-muted">No hay im√°genes disponibles</p>
      }
    </section>

    <!-- =================================================================
         SECCI√ìN 3: VARIANTES Y PRECIOS
         ================================================================= -->
    <section class="card">
      <div class="section-header">
        <h2 class="section-title">Variantes y precios</h2>
        <button type="button" class="btn btn-sm btn-primary" (click)="addVariant()">
          + Agregar variante
        </button>
      </div>

      <!-- Descuentos globales -->
      <div class="global-discounts">
        <h3 class="subsection-title">Descuentos globales</h3>
        @for (tier of d.listing.price_tiers_global; track $index; let i = $index) {
          <div class="discount-row">
            <input
              type="text"
              [(ngModel)]="tier.tier_name"
              class="input input-sm"
              placeholder="Tipo (ej: mayorista)"
              style="flex: 1;"
            />
            <input
              type="number"
              [(ngModel)]="tier.discount_percent"
              class="input input-sm"
              placeholder="%"
              style="width: 80px;"
            />
            <button
              type="button"
              class="btn-icon-sm btn-danger"
              (click)="removeGlobalDiscount(i)"
              [disabled]="d.listing.price_tiers_global.length <= 1"
            >
              ‚úï
            </button>
          </div>
        }
        <button type="button" class="btn btn-sm btn-outline" (click)="addGlobalDiscount()">
          + Agregar descuento
        </button>
      </div>

      <!-- Lista de variantes -->
      <div class="variants-list">
        @for (variant of d.listing.items; track $index; let i = $index) {
          <div class="variant-card">
            <div class="variant-header">
              <span class="variant-number">#{{ i + 1 }}</span>
              <button
                type="button"
                class="btn-icon-sm btn-danger"
                (click)="removeVariant(i)"
                [disabled]="d.listing.items.length <= 1"
              >
                ‚úï
              </button>
            </div>

            <!-- Imagen asociada -->
            @if (variant.image_url) {
              <div class="variant-image-preview">
                <img [src]="variant.image_url" alt="Variante"/>
              </div>
            }

            <!-- Nombre de variante -->
            <div class="form-group">
              <label class="label">Nombre de variante</label>
              <input
                type="text"
                [(ngModel)]="variant.variant_name"
                class="input"
                placeholder="Ej: Matrimonial Rosa"
              />
            </div>

            <!-- Color -->
            <div class="form-group">
              <label class="label">Color</label>
              <div class="color-input-group">
                <input
                  type="text"
                  [(ngModel)]="variant.color"
                  class="input"
                  placeholder="Ej: Rosa, Azul marino"
                />
                <button type="button" class="btn btn-sm" (click)="pickImageForVariant(i)">
                  üì∑ Imagen
                </button>
              </div>
            </div>

            <!-- Stock -->
            <div class="form-group">
              <label class="label">Disponibilidad</label>
              <select [(ngModel)]="variant.stock_state" class="input">
                <option value="in_stock">‚úì Disponible</option>
                <option value="last_pair">‚ö†Ô∏è √öltima pieza</option>
                <option value="unknown_qty">‚ùì Cantidad desconocida</option>
              </select>
            </div>

            <!-- Precios -->
            <div class="prices-section">
              <label class="label">Precios</label>
              @for (price of variant.prices; track $index; let pi = $index) {
                <div class="price-row">
                  <input
                    type="text"
                    [(ngModel)]="price.tier_name"
                    class="input input-sm"
                    placeholder="Tipo"
                    style="flex: 1;"
                  />
                  <input
                    type="number"
                    [(ngModel)]="price.amount"
                    class="input input-sm"
                    placeholder="0.00"
                    style="width: 100px;"
                  />
                  <span class="currency">{{ price.currency }}</span>
                  <button
                    type="button"
                    class="btn-icon-sm btn-danger"
                    (click)="removePriceFromVariant(i, pi)"
                    [disabled]="variant.prices.length <= 1"
                  >
                    ‚úï
                  </button>
                </div>
              }
              <button type="button" class="btn btn-sm btn-outline" (click)="addPriceToVariant(i)">
                + Precio
              </button>
            </div>

            <!-- Notas -->
            <div class="form-group">
              <label class="label">Notas</label>
              <textarea
                [(ngModel)]="variant.notes"
                class="input"
                rows="2"
                placeholder="Notas adicionales..."
              ></textarea>
            </div>
          </div>
        }
      </div>

      @if (d.listing.items.length === 0) {
        <div class="empty-state">
          <p>No hay variantes. Agrega al menos una para continuar.</p>
        </div>
      }
    </section>

    <!-- =================================================================
         SECCI√ìN 4: CONTEXTO RAW (SOLO LECTURA)
         ================================================================= -->
    <section class="card card-secondary">
      <h2 class="section-title">Mensaje original (solo lectura)</h2>
      <div class="raw-message">
        {{ rawText() || "(sin texto)" }}
      </div>
      <small class="hint">ID: {{ id }}</small>
    </section>

    <!-- =================================================================
         ACCIONES FINALES
         ================================================================= -->
    <div class="actions-bar">
      <button type="button" class="btn btn-secondary" (click)="save()">
        üíæ Guardar cambios
      </button>
      <button type="button" class="btn btn-primary" (click)="validate()">
        ‚úì Validar y publicar
      </button>
      <button type="button" class="btn btn-danger" (click)="reject()">
        ‚úï Rechazar
      </button>
    </div>
  }
</div>

<!-- Modal para seleccionar imagen -->
@if (showImagePicker()) {
  <div class="modal-overlay" (click)="closeImagePicker()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>Seleccionar imagen para variante</h3>
      <div class="images-grid">
        @for (img of visibleRawImages(); track img) {
          <button type="button" class="image-card-clickable" (click)="assignImageToVariant(img)">
            <img [src]="img" class="image-thumb" alt="Imagen"/>
            @if (imageColors[img]) {
              <div class="image-color-badge">{{ imageColors[img] }}</div>
            }
          </button>
        }
      </div>
      <button type="button" class="btn btn-secondary" (click)="closeImagePicker()">Cancelar</button>
    </div>
  </div>
}
